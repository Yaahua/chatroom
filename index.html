<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero-TURN P2P Chat (2025 Optimized)</title>
    <style>
        :root{--bg:#0f0f0f;--bg2:#1a1a1a;--text:#e0e0e0;--accent:#00d084;--err:#ff4757;--warn:#ffa502}
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
        body{background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
        .hidden{display:none!important}
        
        #setup{height:100%;display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column}
        .card{background:var(--bg2);padding:30px;border-radius:16px;max-width:500px;width:100%;border:1px solid #333}
        h1{font-size:24px;margin-bottom:10px;color:var(--accent)}
        .info{font-size:12px;color:#888;margin-bottom:20px;line-height:1.5}
        
        button{width:100%;padding:14px;margin:8px 0;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:bold;cursor:pointer;font-size:14px}
        button:hover{opacity:0.9}
        button.secondary{background:#333;color:var(--text)}
        
        textarea{width:100%;height:120px;padding:12px;background:#000;border:1px solid #444;border-radius:8px;color:var(--text);font-family:monospace;font-size:12px;margin:10px 0;resize:none}
        
        #chat{height:100%;display:flex;flex-direction:column;padding:20px}
        #status{padding:10px;background:var(--bg2);border-radius:8px;margin-bottom:10px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
        .badge{padding:4px 8px;border-radius:4px;font-size:11px;background:#333}
        .badge.direct{background:var(--accent);color:#000}
        .badge.relay{background:var(--err);color:#fff}
        .badge.local{background:#3498db;color:#fff}
        
        #messages{flex:1;overflow-y:auto;padding:10px;background:#000;border-radius:8px;margin-bottom:10px;border:1px solid #333}
        .msg{margin:8px 0;padding:10px;background:var(--bg2);border-radius:8px;max-width:80%;word-break:break-all}
        .msg.self{margin-left:auto;background:rgba(0,208,132,0.2);border:1px solid var(--accent)}
        .msg .time{font-size:10px;color:#666;margin-top:4px}
        
        #input{display:flex;gap:10px}
        #input input{flex:1;padding:12px;background:var(--bg2);border:1px solid #444;border-radius:8px;color:var(--text)}
        #input button{width:auto;padding:12px 24px}
        
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:100;padding:20px}
        .modal-content{background:var(--bg2);padding:20px;border-radius:12px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
    </style>
</head>
<body>
    <!-- åˆå§‹è®¾ç½®ç•Œé¢ -->
    <div id="setup">
        <div class="card">
            <h1>ğŸ”® Zero-TURN P2P</h1>
            <div class="info">
                <strong>2025å¹´12æœˆä¼˜åŒ–ç‰ˆ</strong><br>
                â€¢ å±€åŸŸç½‘å†…è‡ªåŠ¨å‘ç°ï¼ˆé›¶é…ç½®ï¼‰<br>
                â€¢ å…¬ç½‘ä¹è§‚ç›´è¿ï¼ˆæ— éœ€TURNæœåŠ¡å™¨ï¼‰<br>
                â€¢ <span style="color:var(--err)">æ³¨æ„ï¼šå¯¹ç§°å‹NAT/ä¼ä¸šé˜²ç«å¢™ä¸‹å¯èƒ½å¤±è´¥</span>
            </div>
            
            <button onclick="App.createRoom()">åˆ›å»ºæˆ¿é—´ï¼ˆç”Ÿæˆé‚€è¯·ç ï¼‰</button>
            <button class="secondary" onclick="App.joinRoom()">åŠ å…¥æˆ¿é—´ï¼ˆç²˜è´´é‚€è¯·ç ï¼‰</button>
            
            <div id="inviteSection" class="hidden" style="margin-top:20px">
                <label style="font-size:12px;color:#888">é‚€è¯·ç ï¼ˆå¤åˆ¶ç»™å¯¹æ–¹ï¼‰ï¼š</label>
                <textarea id="inviteCode" readonly></textarea>
                <button class="secondary" onclick="App.copyInvite()">å¤åˆ¶é‚€è¯·ç </button>
            </div>
            
            <div id="joinSection" class="hidden" style="margin-top:20px">
                <label style="font-size:12px;color:#888">ç²˜è´´å¯¹æ–¹çš„é‚€è¯·ç ï¼š</label>
                <textarea id="joinCode" placeholder="ç²˜è´´ Base64 é‚€è¯·ç ..."></textarea>
                <button onclick="App.connect()">è¿æ¥</button>
            </div>
        </div>
    </div>

    <!-- èŠå¤©ç•Œé¢ -->
    <div id="chat" class="hidden">
        <div id="status">
            <span>
                çŠ¶æ€: <span id="connStatus">è¿æ¥ä¸­...</span>
                <span id="connType" class="badge" style="margin-left:10px">æ£€æµ‹ä¸­</span>
            </span>
            <button class="secondary" style="width:auto;padding:4px 8px;font-size:11px" onclick="location.reload()">æ–­å¼€</button>
        </div>
        
        <div id="messages"></div>
        
        <div id="input">
            <input type="text" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500" onkeypress="if(event.key==='Enter')App.send()">
            <button onclick="App.send()">å‘é€</button>
        </div>
    </div>

    <!-- æ‰‹åŠ¨ä¿¡ä»¤å¤‡ç”¨ï¼ˆå½“è‡ªåŠ¨å¤±è´¥æ—¶ï¼‰ -->
    <div id="manualModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:200;overflow-y:auto;padding:20px">
        <div class="modal-content">
            <h3>ğŸ”„ æ‰‹åŠ¨ä¿¡ä»¤æ¨¡å¼</h3>
            <p style="font-size:12px;color:#888;margin:10px 0">è‡ªåŠ¨è¿æ¥å¤±è´¥ï¼ˆå¯èƒ½å¤„äºå¯¹ç§°å‹NATåï¼‰ã€‚è¯·å¤åˆ¶ä»¥ä¸‹ä»£ç é€šè¿‡å³æ—¶é€šè®¯å·¥å…·å‘é€ç»™å¯¹æ–¹ï¼Œå¹¶ç²˜è´´å¯¹æ–¹å‘æ¥çš„ä»£ç ï¼š</p>
            
            <textarea id="localSDP" readonly></textarea>
            <textarea id="remoteSDP" placeholder="ç²˜è´´å¯¹æ–¹å‘æ¥çš„ SDP..."></textarea>
            
            <button onclick="App.completeManual()">å®Œæˆè¿æ¥</button>
            <button class="secondary" onclick="document.getElementById('manualModal').classList.add('hidden')">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        /**
         * Zero-TURN P2P Chat
         * åŸºäº WebRTC çº¯ STUN + mDNS æœ¬åœ°å‘ç°
         * 2025å¹´12æœˆä¼˜åŒ–ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°å€™é€‰ï¼Œæœ€å¤§åŒ–ç›´è¿æˆåŠŸç‡
         */
        
        const App = {
            pc: null,
            dc: null,
            isInitiator: false,
            inviteData: null,
            
            // ä»…ä½¿ç”¨å…¬å…± STUNï¼ˆæ—  TURNï¼‰
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun.miwifi.com' } // å›½å†…ä¼˜åŒ–
                ],
                iceTransportPolicy: 'all',
                iceCandidatePoolSize: 0, // 0è¡¨ç¤ºä¸é¢„æ”¶é›†ï¼ŒæŒ‰éœ€æ”¶é›†ï¼ˆå‡å°‘æš´éœ²ï¼‰
                // å…³é”®ï¼šgatherPolicy åœ¨ 2025 æ ‡å‡†ä¸­å·²ä¼˜åŒ–æœ¬åœ°å€™é€‰ä¼˜å…ˆçº§
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require'
            },

            createRoom() {
                this.isInitiator = true;
                document.getElementById('inviteSection').classList.remove('hidden');
                document.getElementById('joinSection').classList.add('hidden');
                
                // ç”Ÿæˆæˆ¿é—´å¯†é’¥å’Œåˆå§‹ SDP
                this.initConnection();
            },

            joinRoom() {
                this.isInitiator = false;
                document.getElementById('joinSection').classList.remove('hidden');
                document.getElementById('inviteSection').classList.add('hidden');
            },

            async initConnection() {
                this.pc = new RTCPeerConnection(this.config);
                
                // åˆ›å»ºæ•°æ®é€šé“
                if (this.isInitiator) {
                    this.dc = this.pc.createDataChannel('chat', {
                        ordered: true,
                        maxRetransmits: 3
                    });
                    this.setupDataChannel(this.dc);
                } else {
                    this.pc.ondatachannel = (e) => {
                        this.dc = e.channel;
                        this.setupDataChannel(this.dc);
                    };
                }

                // ICE å€™é€‰æ”¶é›†
                this.pc.onicecandidate = (e) => {
                    if (e.candidate === null) {
                        // æ”¶é›†å®Œæˆ
                        if (this.isInitiator) {
                            this.generateInvite();
                        }
                    }
                };

                // è¿æ¥çŠ¶æ€ç›‘æ§
                this.pc.oniceconnectionstatechange = () => {
                    const state = this.pc.iceConnectionState;
                    document.getElementById('connStatus').textContent = state;
                    
                    if (state === 'connected' || state === 'completed') {
                        this.detectConnectionType();
                        document.getElementById('setup').classList.add('hidden');
                        document.getElementById('chat').classList.remove('hidden');
                    } else if (state === 'failed') {
                        if (this.isInitiator) {
                            document.getElementById('manualModal').classList.remove('hidden');
                            document.getElementById('localSDP').value = btoa(JSON.stringify(this.pc.localDescription));
                        }
                    }
                };

                if (this.isInitiator) {
                    const offer = await this.pc.createOffer();
                    await this.pc.setLocalDescription(offer);
                }
            },

            generateInvite() {
                const desc = this.pc.localDescription;
                const invite = {
                    type: desc.type,
                    sdp: desc.sdp,
                    ts: Date.now()
                };
                const b64 = btoa(JSON.stringify(invite));
                document.getElementById('inviteCode').value = b64;
                this.inviteData = b64;
            },

            async connect() {
                const code = document.getElementById('joinCode').value.trim();
                if (!code) return alert('è¯·è¾“å…¥é‚€è¯·ç ');
                
                try {
                    const invite = JSON.parse(atob(code));
                    
                    await this.initConnection();
                    
                    if (invite.type === 'offer') {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(invite));
                        const answer = await this.pc.createAnswer();
                        await this.pc.setLocalDescription(answer);
                        
                        // æ˜¾ç¤ºåå‘é‚€è¯·ç ï¼ˆç”¨äºå‘èµ·æ–¹è¿æ¥ï¼‰
                        setTimeout(() => {
                            const response = btoa(JSON.stringify({
                                type: this.pc.localDescription.type,
                                sdp: this.pc.localDescription.sdp
                            }));
                            alert('è¿æ¥å·²æ¥å—ï¼è¯·å°†ä»¥ä¸‹å“åº”ç å‘é€ç»™é‚€è¯·æ–¹ï¼š\n\n' + response.substring(0, 50) + '...\n\nï¼ˆå·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼‰');
                            navigator.clipboard.writeText(response);
                        }, 1000);
                    }
                } catch (e) {
                    alert('æ— æ•ˆçš„é‚€è¯·ç ');
                }
            },

            // å®Œæˆæ‰‹åŠ¨ä¿¡ä»¤ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
            async completeManual() {
                const remote = document.getElementById('remoteSDP').value.trim();
                try {
                    const desc = JSON.parse(atob(remote));
                    await this.pc.setRemoteDescription(new RTCSessionDescription(desc));
                    document.getElementById('manualModal').classList.add('hidden');
                } catch (e) {
                    alert('æ— æ•ˆçš„ SDP');
                }
            },

            setupDataChannel(dc) {
                dc.onopen = () => {
                    console.log('DataChannel å·²è¿æ¥');
                    this.addMessage('ç³»ç»Ÿ', 'å®‰å…¨é€šé“å·²å»ºç«‹ï¼ˆç«¯åˆ°ç«¯åŠ å¯†ï¼‰', 'info');
                };
                
                dc.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    this.addMessage('å¯¹æ–¹', data.msg, 'other');
                };
            },

            detectConnectionType() {
                // æ£€æµ‹è¿æ¥ç±»å‹ï¼ˆæœ¬åœ°/ç›´è¿/ä¸­ç»§ï¼‰
                this.pc.getStats().then(stats => {
                    let type = 'unknown';
                    stats.forEach(report => {
                        if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                            const local = stats.get(report.localCandidateId);
                            if (local) {
                                if (local.candidateType === 'host') type = 'local';
                                else if (local.candidateType === 'srflx') type = 'direct';
                                else if (local.candidateType === 'relay') type = 'relay';
                            }
                        }
                    });
                    
                    const badge = document.getElementById('connType');
                    if (type === 'local') {
                        badge.textContent = 'å±€åŸŸç½‘ç›´è¿';
                        badge.className = 'badge local';
                    } else if (type === 'direct') {
                        badge.textContent = 'å…¬ç½‘P2P';
                        badge.className = 'badge direct';
                    } else {
                        badge.textContent = 'è¿æ¥å¤±è´¥';
                        badge.className = 'badge relay';
                    }
                });
            },

            send() {
                const input = document.getElementById('msgInput');
                const msg = input.value.trim();
                if (!msg || !this.dc || this.dc.readyState !== 'open') return;
                
                this.dc.send(JSON.stringify({msg, time: Date.now()}));
                this.addMessage('æˆ‘', msg, 'self');
                input.value = '';
            },

            addMessage(from, text, type) {
                const div = document.createElement('div');
                div.className = `msg ${type}`;
                const time = new Date().toLocaleTimeString();
                div.innerHTML = `<div style="font-size:11px;opacity:0.7;margin-bottom:4px">${from} Â· ${time}</div>${text}`;
                document.getElementById('messages').appendChild(div);
                div.scrollIntoView();
            },

            copyInvite() {
                const code = document.getElementById('inviteCode').value;
                navigator.clipboard.writeText(code);
                alert('é‚€è¯·ç å·²å¤åˆ¶ï¼');
            }
        };

        // å¦‚æœæ˜¯å“åº”æ–¹ï¼Œç›‘å¬ç²˜è´´
        if (!App.isInitiator) {
            window.addEventListener('paste', (e) => {
                const text = e.clipboardData.getData('text');
                if (text.length > 100 && text.includes('answer')) {
                    document.getElementById('joinCode').value = text;
                }
            });
        }
    </script>
</body>
</html>
