<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero-TURN P2P Chat (çŸ­ç ç‰ˆ)</title>
    <script src='https://cdn.scaledrone.com/scaledrone.min.js'></script>
    <style>
        :root{--bg:#0f0f0f;--bg2:#1a1a1a;--text:#e0e0e0;--accent:#00d084;--err:#ff4757;--warn:#ffa502;--info:#3498db}
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
        body{background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
        .hidden{display:none!important}
        
        #setup{height:100%;display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column}
        .card{background:var(--bg2);padding:30px;border-radius:16px;max-width:500px;width:100%;border:1px solid #333}
        h1{font-size:24px;margin-bottom:10px;color:var(--accent)}
        .info{font-size:12px;color:#888;margin-bottom:20px;line-height:1.5}
        
        button{width:100%;padding:14px;margin:8px 0;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:bold;cursor:pointer;font-size:14px}
        button:hover{opacity:0.9;transform:translateY(-1px)}
        button.secondary{background:#333;color:var(--text)}
        button.small{width:auto;padding:8px 16px;font-size:12px}
        button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        
        #chat{height:100%;display:flex;flex-direction:column;padding:20px}
        #status{padding:10px;background:var(--bg2);border-radius:8px;margin-bottom:10px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
        .badge{padding:4px 8px;border-radius:4px;font-size:11px;background:#333}
        .badge.direct{background:var(--accent);color:#000}
        .badge.failed{background:var(--err);color:#fff}
        .badge.waiting{background:var(--warn);color:#000}
        
        #messages{flex:1;overflow-y:auto;padding:10px;background:#000;border-radius:8px;margin-bottom:10px;border:1px solid #333}
        .msg{margin:8px 0;padding:10px;background:var(--bg2);border-radius:8px;max-width:80%;word-break:break-all}
        .msg.self{margin-left:auto;background:rgba(0,208,132,0.2);border:1px solid var(--accent)}
        .msg.system{text-align:center;background:transparent;color:#666;font-size:12px;max-width:100%;padding:5px}
        .msg.error{background:rgba(255,71,87,0.1);border:1px solid var(--err);color:#ff4757}
        
        #input{display:flex;gap:10px}
        #input input{flex:1;padding:12px;background:var(--bg2);border:1px solid #444;border-radius:8px;color:var(--text)}
        #input button{width:auto;padding:12px 24px}
        
        .code-display{font-size:32px;font-weight:bold;color:var(--accent);letter-spacing:8px;text-align:center;padding:20px;background:rgba(0,208,132,0.1);border-radius:8px;margin:20px 0;border:2px dashed var(--accent);font-family:monospace}
        .loading{display:flex;align-items:center;justify-content:center;gap:10px;color:var(--warn)}
        .spinner{width:20px;height:20px;border:2px solid var(--warn);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        input[type="text"]{width:100%;padding:12px;background:#000;border:1px solid #444;border-radius:8px;color:var(--text);text-transform:uppercase;font-family:monospace;font-size:16px;text-align:center;letter-spacing:4px}
    </style>
</head>
<body>
    <div id="setup">
        <div class="card">
            <h1>ğŸ”® Zero-TURN P2P (çŸ­ç ç‰ˆ)</h1>
            <div class="info">
                <strong>è‡ªåŠ¨ä¿¡ä»¤ç‰ˆæœ¬</strong><br>
                â€¢ æ— éœ€å¤åˆ¶ç²˜è´´é•¿ä¸²é‚€è¯·ç <br>
                â€¢ è¾“å…¥6ä½çŸ­ç å³å¯è‡ªåŠ¨è¿æ¥<br>
                â€¢ ä½¿ç”¨å…è´¹ä¿¡ä»¤æœåŠ¡ï¼ˆScaledroneï¼‰<br>
                <span style="color:var(--warn)">æç¤ºï¼šçŸ­ç æœ‰æ•ˆæœŸ5åˆ†é’Ÿï¼Œè¿‡æœŸéœ€é‡æ–°åˆ›å»º</span>
            </div>
            
            <button onclick="App.createRoom()" id="createBtn">åˆ›å»ºæˆ¿é—´</button>
            <button class="secondary" onclick="App.showJoin()" id="joinBtn">åŠ å…¥æˆ¿é—´</button>
            
            <div id="createPanel" class="hidden" style="margin-top:20px">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>æ­£åœ¨åˆ›å»ºæˆ¿é—´...</span>
                </div>
            </div>
            
            <div id="joinPanel" class="hidden" style="margin-top:20px">
                <label style="font-size:12px;color:#888">è¾“å…¥6ä½æˆ¿é—´ç ï¼š</label>
                <input type="text" id="joinCode" placeholder="ABC123" maxlength="6" style="margin-top:10px">
                <button onclick="App.joinRoom()" id="connectBtn" style="margin-top:10px">è¿æ¥</button>
            </div>
        </div>
    </div>

    <div id="chat" class="hidden">
        <div id="status">
            <span>
                æˆ¿é—´: <span id="roomCode" style="color:var(--accent);font-weight:bold">-</span>
                <span id="connType" class="badge waiting" style="margin-left:10px">ç­‰å¾…è¿æ¥</span>
            </span>
            <button class="secondary small" onclick="App.disconnect()">æ–­å¼€</button>
        </div>
        
        <div id="messages"></div>
        
        <div id="input" style="display:none">
            <input type="text" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="1000" onkeypress="if(event.key==='Enter')App.send()">
            <button onclick="App.send()">å‘é€</button>
        </div>
    </div>

    <script>
        // Scaledrone å…è´¹é¢‘é“IDï¼ˆæ¯æ—¥é™é¢10,000äº‹ä»¶ï¼Œ20å¹¶å‘ï¼‰
        // å¦‚éœ€ç§æœ‰ï¼Œè¯·å‰å¾€ https://scaledrone.com æ³¨å†Œè·å–è‡ªå·±çš„ID
        const SCALEDRONE_ID = 'OoG0iE4ZtT2E3K5i'; 
        
        const App = {
            pc: null,
            dc: null,
            drone: null,
            room: null,
            isInitiator: false,
            shortCode: null,
            
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ],
                iceCandidatePoolSize: 10
            },

            generateShortCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            },

            async createRoom() {
                this.isInitiator = true;
                this.shortCode = this.generateShortCode();
                
                document.getElementById('createBtn').classList.add('hidden');
                document.getElementById('joinBtn').classList.add('hidden');
                document.getElementById('createPanel').classList.remove('hidden');
                
                // åˆå§‹åŒ–WebRTC
                await this.initConnection();
                
                // è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨
                this.connectSignaling();
            },

            showJoin() {
                document.getElementById('joinPanel').classList.remove('hidden');
                document.getElementById('joinBtn').classList.add('hidden');
                document.getElementById('createBtn').classList.add('hidden');
                document.getElementById('joinCode').focus();
            },

            async joinRoom() {
                const code = document.getElementById('joinCode').value.trim().toUpperCase();
                if (code.length !== 6) return alert('è¯·è¾“å…¥6ä½æˆ¿é—´ç ');
                
                this.isInitiator = false;
                this.shortCode = code;
                
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = 'è¿æ¥ä¸­...';
                
                await this.initConnection();
                this.connectSignaling();
            },

            connectSignaling() {
                this.drone = new ScaleDrone(SCALEDRONE_ID);
                
                this.drone.on('open', (error) => {
                    if (error) {
                        this.addMessage('ç³»ç»Ÿ', 'ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥å¤±è´¥: ' + error.message, 'error');
                        return;
                    }
                    
                    this.room = this.drone.subscribe('p2p-room-' + this.shortCode);
                    
                    this.room.on('open', (error) => {
                        if (error) {
                            this.addMessage('ç³»ç»Ÿ', 'æˆ¿é—´è®¢é˜…å¤±è´¥', 'error');
                            return;
                        }
                        
                        document.getElementById('setup').classList.add('hidden');
                        document.getElementById('chat').classList.remove('hidden');
                        document.getElementById('roomCode').textContent = this.shortCode;
                        
                        if (this.isInitiator) {
                            this.addMessage('ç³»ç»Ÿ', `æˆ¿é—´ ${this.shortCode} å·²åˆ›å»ºï¼Œç­‰å¾…å¯¹æ–¹åŠ å…¥...`, 'system');
                            // åˆ›å»ºè€…ç­‰å¾…åŠ å…¥è¯·æ±‚
                            this.room.on('data', (data, member) => {
                                this.handleSignalingData(data);
                            });
                        } else {
                            this.addMessage('ç³»ç»Ÿ', `æ­£åœ¨åŠ å…¥æˆ¿é—´ ${this.shortCode}...`, 'system');
                            // åŠ å…¥è€…å‘é€åŠ å…¥è¯·æ±‚
                            this.publish('join-request', {});
                            this.room.on('data', (data, member) => {
                                this.handleSignalingData(data);
                            });
                        }
                    });
                });
            },

            async initConnection() {
                this.pc = new RTCPeerConnection(this.config);
                
                if (this.isInitiator) {
                    this.dc = this.pc.createDataChannel('chat', {ordered: true});
                    this.setupDataChannel(this.dc);
                } else {
                    this.pc.ondatachannel = (e) => {
                        this.dc = e.channel;
                        this.setupDataChannel(this.dc);
                    };
                }

                // æ”¶é›†ICEå€™é€‰
                this.pc.onicecandidate = (e) => {
                    if (e.candidate) {
                        this.publish('ice-candidate', {candidate: e.candidate});
                    }
                };

                this.pc.oniceconnectionstatechange = () => {
                    this.handleConnectionStateChange();
                };

                if (this.isInitiator) {
                    const offer = await this.pc.createOffer();
                    await this.pc.setLocalDescription(offer);
                }
            },

            async handleSignalingData(data) {
                try {
                    if (data.type === 'join-request' && this.isInitiator) {
                        // æœ‰äººåŠ å…¥ï¼Œå‘é€offer
                        this.publish('offer', {sdp: this.pc.localDescription});
                    }
                    else if (data.type === 'offer' && !this.isInitiator) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                        const answer = await this.pc.createAnswer();
                        await this.pc.setLocalDescription(answer);
                        this.publish('answer', {sdp: answer});
                    }
                    else if (data.type === 'answer' && this.isInitiator) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    }
                    else if (data.type === 'ice-candidate') {
                        await this.pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                } catch (e) {
                    console.error('ä¿¡ä»¤å¤„ç†é”™è¯¯:', e);
                }
            },

            publish(type, data) {
                if (this.drone && this.room) {
                    this.drone.publish({
                        room: 'p2p-room-' + this.shortCode,
                        message: {type, ...data}
                    });
                }
            },

            handleConnectionStateChange() {
                const state = this.pc.iceConnectionState;
                const badge = document.getElementById('connType');
                document.getElementById('connType').textContent = state;
                
                if (state === 'connected' || state === 'completed') {
                    badge.className = 'badge direct';
                    badge.textContent = 'å·²è¿æ¥';
                    document.getElementById('input').style.display = 'flex';
                    this.addMessage('ç³»ç»Ÿ', 'âœ… P2Pè¿æ¥æˆåŠŸï¼å¯ä»¥å¼€å§‹èŠå¤©äº†', 'system');
                    // 5ç§’åæ–­å¼€ä¿¡ä»¤ï¼ˆä¿æŠ¤éšç§ï¼‰
                    setTimeout(() => {
                        if (this.drone) this.drone.close();
                    }, 5000);
                } else if (state === 'failed') {
                    badge.className = 'badge failed';
                    this.addMessage('ç³»ç»Ÿ', 'âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡æ–°åˆ›å»ºæˆ¿é—´', 'error');
                }
            },

            setupDataChannel(dc) {
                dc.onopen = () => {
                    console.log('DataChannel å·²æ‰“å¼€');
                };
                
                dc.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        this.addMessage('å¯¹æ–¹', data.msg, 'other');
                    } catch(err) {
                        this.addMessage('å¯¹æ–¹', e.data, 'other');
                    }
                };

                dc.onclose = () => {
                    this.addMessage('ç³»ç»Ÿ', 'æ•°æ®é€šé“å·²å…³é—­', 'system');
                };
            },

            send() {
                const input = document.getElementById('msgInput');
                const msg = input.value.trim();
                if (!msg || !this.dc || this.dc.readyState !== 'open') {
                    if (this.dc?.readyState !== 'open') {
                        this.addMessage('ç³»ç»Ÿ', 'å°šæœªè¿æ¥ï¼Œæ— æ³•å‘é€', 'error');
                    }
                    return;
                }
                
                this.dc.send(JSON.stringify({msg, time: Date.now()}));
                this.addMessage('æˆ‘', msg, 'self');
                input.value = '';
            },

            addMessage(from, text, type) {
                const div = document.createElement('div');
                div.className = `msg ${type}`;
                const time = new Date().toLocaleTimeString();
                div.innerHTML = `<div style="font-size:11px;opacity:0.7;margin-bottom:4px">${from} Â· ${time}</div><div>${text}</div>`;
                document.getElementById('messages').appendChild(div);
                div.scrollIntoView({behavior: 'smooth'});
            },

            disconnect() {
                if (confirm('ç¡®å®šè¦æ–­å¼€è¿æ¥å—ï¼Ÿ')) {
                    if (this.dc) this.dc.close();
                    if (this.pc) this.pc.close();
                    if (this.drone) this.drone.close();
                    location.reload();
                }
            }
        };
    </script>
</body>
</html>
