<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#0f0f13;color:#e0e0f0;height:100vh;overflow:hidden}.w{max-width:800px;margin:0 auto;height:100vh;display:flex;flex-direction:column}.h{padding:20px;border-bottom:1px solid #2a2a35;display:flex;justify-content:space-between;align-items:center;background:#16161e}.c{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}.i{padding:20px;border-top:1px solid #2a2a35;display:flex;gap:10px;background:#16161e}input{flex:1;background:#1a1a24;border:1px solid #2a2a35;color:#fff;padding:12px 16px;border-radius:8px;outline:none}button{background:#3b82f6;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600}button:hover{background:#2563eb}.m{max-width:70%;padding:12px 16px;border-radius:12px;word-wrap:break-word;font-size:14px}.o{align-self:flex-end;background:#3b82f6}.t{align-self:flex-start;background:#2a2a35}.s{text-align:center;color:#6b7280;font-size:12px;margin:8px 0}#a{position:fixed;inset:0;background:#0f0f13;display:flex;align-items:center;justify-content:center;z-index:50}.b{background:#16161e;padding:40px;border-radius:16px;border:1px solid #2a2a35;width:90%;max-width:400px;box-shadow:0 25px 50px -12px rgba(0,0,0,.5)}.t2{font-size:24px;margin-bottom:24px;text-align:center;background:linear-gradient(90deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;color:transparent}.x{margin-bottom:16px}.x label{display:block;font-size:12px;color:#6b7280;margin-bottom:6px;text-transform:uppercase}.x input{width:100%;background:#1a1a24;border:1px solid #2a2a35}#l{background:#10b981;padding:4px 12px;border-radius:20px;font-size:12px;color:white}.d{background:#ef4444}
        #err{color:#ef4444;font-size:13px;margin-top:12px;text-align:center;display:none}
        #warn{color:#f59e0b;font-size:12px;margin-top:8px;text-align:center;display:none}
    </style>
</head>
<body>
    <div id="a">
        <div class="b">
            <div class="t2">Secure Channel</div>
            <div class="x"><label>Room</label><input type="text" id="r" placeholder="room-id" autocomplete="off"></div>
            <div class="x"><label>Key</label><input type="password" id="k" placeholder="password" autocomplete="off"></div>
            <div class="x"><label>User</label><input type="text" id="u" value="User" maxlength="8"></div>
            <button onclick="window.j()">Connect</button>
            <div id="err"></div>
            <div id="warn"></div>
            <div style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
                <span id="l">● Secure</span><span style="font-size:11px;color:#6b7280">E2EE</span>
            </div>
        </div>
    </div>

    <div class="w" id="m" style="display:none">
        <div class="h">
            <div><div id="n" style="font-weight:600">Room</div><div style="font-size:12px;color:#6b7280;margin-top:4px"><span id="p">1</span> peers</div></div>
            <button style="padding:6px 12px;background:#2a2a35;font-size:12px" onclick="window.q()">Exit</button>
        </div>
        <div class="c" id="s"></div>
        <div class="i">
            <input type="text" id="i" placeholder="Message..." onkeypress="if(event.key==='Enter')window.snd()">
            <button onclick="window.snd()">Send</button>
        </div>
    </div>

<script>
(function() {
    const errDiv = document.getElementById('err');
    const warnDiv = document.getElementById('warn');
    
    function showError(msg) {
        errDiv.style.display = 'block';
        errDiv.textContent = '❌ ' + msg;
        console.error(msg);
    }
    
    function showWarn(msg) {
        warnDiv.style.display = 'block';
        warnDiv.textContent = '⚠️ ' + msg;
    }
    
    // 检查是否在安全上下文 (HTTPS 或 localhost)
    if (!window.isSecureContext) {
        showError('必须使用 HTTPS 或 localhost 访问此页面。请使用本地服务器（如 Live Server）打开，不要直接双击文件。');
        return; // 阻止后续执行
    }
    
    // 检查浏览器支持
    if (!window.crypto || !window.crypto.subtle) {
        showError('浏览器不支持 Web Crypto API，请使用现代浏览器（Chrome/Edge/Firefox/Safari）');
        return;
    }
    
    try {
        const $ = document;
        const w = window;      // 原代码用 b，为避免混淆改用 w
        const c = crypto.subtle; // ✅ 修复：原代码写成 const crypto.subtle 导致语法错误！
        const h = new TextEncoder();
        const e = $.getElementById.bind($);
        
        // 用于加密解密的密钥将存储在 w._k
        
        w.j = async function() {
            try {
                const r = e('r').value.trim();
                const k = e('k').value;
                const u = e('u').value || 'User';
                
                if (!r || !k) {
                    showError('请填写 Room 和 Key');
                    return;
                }
                
                // 隐藏登录框，显示主界面
                e('a').style.display = 'none';
                e('m').style.display = 'flex';
                e('n').textContent = r;
                
                // 派生密钥
                const keyMaterial = await c.importKey(
                    'raw', 
                    h.encode(r + k), 
                    {name: 'PBKDF2'}, 
                    false, 
                    ['deriveKey']
                );
                
                const key = await c.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: h.encode('s'),
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    {name: 'AES-GCM', length: 256},
                    false,
                    ['encrypt', 'decrypt']
                );
                
                w._k = key;
                w._u = u;
                w._r = r;
                
                addMsg('系统: 已连接到 ' + r, false);
                
                // 模拟在线人数变化
                setInterval(() => {
                    const peers = 1 + Math.floor(Math.random() * 3);
                    const el = e('p');
                    if (el) el.textContent = peers + ' peers';
                }, 3000);
                
            } catch (error) {
                showError('连接失败: ' + error.message);
                console.error(error);
            }
        };
        
        // ✅ 修复：变量名冲突（原代码 enc 函数内用 const b 覆盖了外层的 b/window）
        w.enc = async function(text) {
            const iv = c.getRandomValues(new Uint8Array(12));
            const data = h.encode(JSON.stringify({t: text, d: Date.now()}));
            const encrypted = await c.encrypt(
                {name: 'AES-GCM', iv: iv},
                w._k,
                data
            );
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            return btoa(String.fromCharCode(...combined));
        };
        
        w.dec = async function(base64) {
            try {
                const data = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                const iv = data.slice(0, 12);
                const encrypted = data.slice(12);
                const decrypted = await c.decrypt(
                    {name: 'AES-GCM', iv: iv},
                    w._k,
                    encrypted
                );
                return JSON.parse(new TextDecoder().decode(decrypted)).t;
            } catch (e) {
                return null;
            }
        };
        
        w.snd = function() {
            const inp = e('i');
            const val = inp.value.trim();
            if (!val) return;
            
            // 演示：加密并显示
            w.enc(val).then(() => {
                addMsg(val, true);
                inp.value = '';
                setTimeout(() => addMsg('系统: 消息已发送', false), 500);
            }).catch(err => {
                addMsg('系统: 加密失败 - ' + err.message, false);
            });
        };
        
        function addMsg(text, isOwn) {
            const div = $.createElement('div');
            const container = e('s');
            div.className = 'm ' + (isOwn ? 'o' : 't');
            div.textContent = (isOwn ? 'You: ' : 'Peer: ') + text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        w.q = function() {
            location.reload();
        };
        
        // Enter 键登录
        e('k').addEventListener('keydown', function(evt) {
            if (evt.key === 'Enter') w.j();
        });
        
        console.log('初始化成功');
        
    } catch (e) {
        showError('初始化失败: ' + e.message);
        console.error(e);
    }
})();
</script>
</body>
</html>
