<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero-TURN P2P Chat (Short Code)</title>
    <style>
        :root{--bg:#0f0f0f;--bg2:#1a1a1a;--text:#e0e0e0;--accent:#00d084;--err:#ff4757;--warn:#ffa502}
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
        body{background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center;padding:20px}
        
        .card{background:var(--bg2);padding:40px;border-radius:16px;max-width:420px;width:100%;border:1px solid #333;text-align:center}
        h1{font-size:28px;margin-bottom:10px;color:var(--accent)}
        p{color:#888;font-size:14px;margin-bottom:30px;line-height:1.5}
        
        .code-display{font-size:48px;font-weight:bold;color:var(--accent);letter-spacing:8px;margin:20px 0;font-family:monospace;background:rgba(0,208,132,0.1);padding:20px;border-radius:8px;border:2px dashed var(--accent)}
        .status{margin:20px 0;font-size:14px;color:#aaa}
        
        input{width:100%;padding:16px;background:#000;border:1px solid #444;border-radius:8px;color:var(--text);font-size:24px;text-align:center;letter-spacing:4px;font-family:monospace;text-transform:uppercase;margin-bottom:15px}
        input:focus{outline:none;border-color:var(--accent)}
        
        button{width:100%;padding:16px;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:bold;cursor:pointer;font-size:16px;margin-top:10px}
        button:hover{opacity:0.9}
        button:disabled{opacity:0.5;cursor:not-allowed;background:#555;color:#888}
        button.secondary{background:#333;color:var(--text)}
        
        #chat{position:fixed;inset:0;background:var(--bg);display:none;flex-direction:column;padding:20px}
        #messages{flex:1;overflow-y:auto;padding:15px;background:#000;border-radius:8px;margin-bottom:10px;border:1px solid #333}
        .msg{margin:8px 0;padding:12px;background:var(--bg2);border-radius:8px;max-width:80%;word-break:break-all}
        .msg.self{margin-left:auto;background:rgba(0,208,132,0.2);border:1px solid var(--accent)}
        .msg.system{text-align:center;background:transparent;color:#666;font-size:12px;max-width:100%}
        .msg .time{font-size:10px;color:#666;margin-top:4px}
        
        #input{display:flex;gap:10px}
        #input input{flex:1;font-size:14px;text-align:left;letter-spacing:normal;text-transform:none}
        #input button{width:auto;padding:12px 24px}
        
        .hidden{display:none!important}
        
        /* åŠ è½½åŠ¨ç”» */
        .loader{display:inline-block;width:20px;height:20px;border:3px solid rgba(0,208,132,0.3);border-radius:50%;border-top-color:var(--accent);animation:spin 1s ease-in-out infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        .error{color:var(--err);font-size:14px;margin-top:10px}
    </style>
</head>
<body>

<!-- ä¸»é¡µ -->
<div id="home" class="card">
    <h1>ğŸ“¡ P2P ç›´è¿</h1>
    <p>æ— éœ€æœåŠ¡å™¨ï¼Œç«¯åˆ°ç«¯åŠ å¯†èŠå¤©<br>åªéœ€ 6 ä½çŸ­ç å³å¯è¿æ¥</p>
    
    <button onclick="App.createRoom()" id="createBtn">åˆ›å»ºæˆ¿é—´</button>
    
    <div style="margin:20px 0;height:1px;background:#333"></div>
    
    <input type="text" id="joinInput" placeholder="è¾“å…¥6ä½çŸ­ç " maxlength="6">
    <button class="secondary" onclick="App.joinRoom()">åŠ å…¥æˆ¿é—´</button>
</div>

<!-- ç­‰å¾…é¡µï¼ˆåˆ›å»ºè€…ï¼‰ -->
<div id="waiting" class="card hidden">
    <h1>â³ ç­‰å¾…è¿æ¥</h1>
    <p>è¯·è®©å¯¹æ–¹è¾“å…¥ä»¥ä¸‹çŸ­ç ï¼š</p>
    <div class="code-display" id="roomCode">------</div>
    <div class="status">
        <span class="loader"></span> ç­‰å¾…å¯¹æ–¹åŠ å…¥...
    </div>
    <button class="secondary" onclick="location.reload()">å–æ¶ˆ</button>
</div>

<!-- èŠå¤©é¡µ -->
<div id="chat">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <span style="font-size:12px;color:#888">çŸ­ç : <b id="displayCode" style="color:var(--accent)">----</b></span>
        <span id="connStatus" style="font-size:12px;color:var(--warn)">è¿æ¥ä¸­...</span>
        <button class="secondary" style="width:auto;padding:8px 16px;font-size:12px" onclick="location.reload()">æ–­å¼€</button>
    </div>
    
    <div id="messages"></div>
    
    <div id="input">
        <input type="text" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="1000">
        <button onclick="App.send()">å‘é€</button>
    </div>
</div>

<script>
/**
 * é…ç½®ï¼šä½¿ç”¨ Firebase Realtime Database ä½œä¸ºå…è´¹ä¿¡ä»¤æœåŠ¡å™¨
 * æ³¨æ„ï¼šè¿™æ˜¯å…¬å¼€çš„æµ‹è¯•æ•°æ®åº“ï¼Œä»…ä¾›æ¼”ç¤ºã€‚å®é™…ä½¿ç”¨è¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ Firebase URL
 * è·å–æ–¹å¼ï¼šhttps://firebase.google.com/ â†’ åˆ›å»ºé¡¹ç›® â†’ Realtime Database â†’ å¤åˆ¶é“¾æ¥
 */
const CONFIG = {
    signalServer: 'https://p2p-chat-signal-default-rtdb.firebaseio.com', // ç¤ºä¾‹åœ°å€ï¼Œå»ºè®®æ›¿æ¢
    iceServers: [
        {urls: 'stun:stun.l.google.com:19302'},
        {urls: 'stun:stun1.l.google.com:19302'}
    ]
};

const App = {
    pc: null,
    dc: null,
    isInitiator: false,
    code: null,
    pollTimer: null,
    
    generateCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        return Array(6).fill(0).map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
    },
    
    // ä¿¡ä»¤æœåŠ¡å™¨æ“ä½œ
    async signal(method, data = null) {
        const url = `${CONFIG.signalServer}/${this.code}.json`;
        if (method === 'GET') {
            const res = await fetch(url);
            return res.json();
        } else if (method === 'PUT') {
            await fetch(url, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else if (method === 'DELETE') {
            await fetch(url, {method: 'DELETE'});
        }
    },
    
    async createRoom() {
        this.isInitiator = true;
        this.code = this.generateCode();
        
        // æ£€æŸ¥çŸ­ç æ˜¯å¦è¢«å ç”¨
        const existing = await this.signal('GET');
        if (existing) {
            // å¦‚æœè¢«å ç”¨ï¼Œé‡æ–°ç”Ÿæˆ
            return this.createRoom();
        }
        
        document.getElementById('home').classList.add('hidden');
        document.getElementById('waiting').classList.remove('hidden');
        document.getElementById('roomCode').textContent = this.code;
        
        // åˆå§‹åŒ–è¿æ¥
        await this.initConnection();
        
        // åˆ›å»º Offer
        const offer = await this.pc.createOffer();
        await this.pc.setLocalDescription(offer);
        
        // ç­‰å¾… ICE æ”¶é›†å®Œæˆï¼ˆæ”¶é›†æ‰€æœ‰ç½‘ç»œå€™é€‰ï¼‰
        await this.waitForIceComplete();
        
        // ä¸Šä¼ åˆ°ä¿¡ä»¤æœåŠ¡å™¨ï¼ˆ5åˆ†é’Ÿåè‡ªåŠ¨è¿‡æœŸï¼‰
        await this.signal('PUT', {
            offer: this.pc.localDescription,
            timestamp: Date.now()
        });
        
        // å¼€å§‹è½®è¯¢ç­‰å¾… Answer
        this.pollForAnswer();
    },
    
    async joinRoom() {
        const code = document.getElementById('joinInput').value.trim().toUpperCase();
        if (!code || code.length !== 6) return alert('è¯·è¾“å…¥6ä½çŸ­ç ');
        
        this.isInitiator = false;
        this.code = code;
        
        // è·å– Offer
        const signal = await this.signal('GET');
        if (!signal || !signal.offer) {
            return alert('æˆ¿é—´ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
        }
        
        document.getElementById('home').classList.add('hidden');
        document.getElementById('chat').style.display = 'flex';
        document.getElementById('displayCode').textContent = code;
        
        await this.initConnection();
        
        // è®¾ç½®è¿œç«¯æè¿°
        await this.pc.setRemoteDescription(new RTCSessionDescription(signal.offer));
        
        // åˆ›å»º Answer
        const answer = await this.pc.createAnswer();
        await this.pc.setLocalDescription(answer);
        
        await this.waitForIceComplete();
        
        // ä¸Šä¼  Answer
        await this.signal('PUT', {
            ...signal,
            answer: this.pc.localDescription
        });
        
        this.addMessage('ç³»ç»Ÿ', 'å·²å‘é€å“åº”ï¼Œç­‰å¾…è¿æ¥...', 'system');
    },
    
    async initConnection() {
        this.pc = new RTCPeerConnection({iceServers: CONFIG.iceServers});
        
        if (this.isInitiator) {
            this.dc = this.pc.createDataChannel('chat', {ordered: true});
            this.setupDataChannel(this.dc);
        } else {
            this.pc.ondatachannel = (e) => {
                this.dc = e.channel;
                this.setupDataChannel(this.dc);
            };
        }
        
        this.pc.oniceconnectionstatechange = () => {
            const state = this.pc.iceConnectionState;
            const statusEl = document.getElementById('connStatus');
            
            if (state === 'connected' || state === 'completed') {
                statusEl.textContent = 'å·²è¿æ¥';
                statusEl.style.color = 'var(--accent)';
                if (this.isInitiator) {
                    document.getElementById('waiting').classList.add('hidden');
                    document.getElementById('chat').style.display = 'flex';
                    document.getElementById('displayCode').textContent = this.code;
                }
                this.addMessage('ç³»ç»Ÿ', 'âœ… è¿æ¥æˆåŠŸï¼å¼€å§‹èŠå¤©å§', 'system');
                // è¿æ¥æˆåŠŸåæ¸…ç†ä¿¡ä»¤æ•°æ®ï¼ˆä¿æŠ¤éšç§ï¼‰
                setTimeout(() => this.signal('DELETE'), 2000);
            } else if (state === 'failed') {
                statusEl.textContent = 'è¿æ¥å¤±è´¥';
                statusEl.style.color = 'var(--err)';
                this.addMessage('ç³»ç»Ÿ', 'âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•', 'error');
            } else if (state === 'checking') {
                statusEl.textContent = 'è¿æ¥ä¸­...';
            }
        };
    },
    
    setupDataChannel(dc) {
        dc.onopen = () => console.log('DataChannel å·²è¿æ¥');
        dc.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                this.addMessage('å¯¹æ–¹', data.msg, 'other');
            } catch(e) {
                this.addMessage('å¯¹æ–¹', e.data, 'other');
            }
        };
        dc.onclose = () => this.addMessage('ç³»ç»Ÿ', 'å¯¹æ–¹å·²æ–­å¼€è¿æ¥', 'system');
    },
    
    async waitForIceComplete() {
        if (this.pc.iceGatheringState === 'complete') return;
        
        return new Promise(resolve => {
            const check = setInterval(() => {
                if (this.pc.iceGatheringState === 'complete') {
                    clearInterval(check);
                    resolve();
                }
            }, 200);
            // è¶…æ—¶ä¿æŠ¤ï¼ˆ5ç§’ï¼‰
            setTimeout(() => { clearInterval(check); resolve(); }, 5000);
        });
    },
    
    async pollForAnswer() {
        this.pollTimer = setInterval(async () => {
            const signal = await this.signal('GET');
            if (signal && signal.answer) {
                clearInterval(this.pollTimer);
                await this.pc.setRemoteDescription(new RTCSessionDescription(signal.answer));
            }
        }, 1500);
        
        // 5åˆ†é’Ÿè¶…æ—¶æ¸…ç†
        setTimeout(() => {
            clearInterval(this.pollTimer);
            if (this.pc && this.pc.iceConnectionState !== 'connected') {
                this.addMessage('ç³»ç»Ÿ', 'è¿æ¥è¶…æ—¶ï¼Œæˆ¿é—´å·²å…³é—­', 'error');
                this.signal('DELETE');
            }
        }, 5 * 60 * 1000);
    },
    
    send() {
        const input = document.getElementById('msgInput');
        const msg = input.value.trim();
        if (!msg || !this.dc || this.dc.readyState !== 'open') {
            if (this.dc?.readyState !== 'open') {
                alert('å°šæœªè¿æ¥ï¼Œæ— æ³•å‘é€');
            }
            return;
        }
        
        this.dc.send(JSON.stringify({msg, time: Date.now()}));
        this.addMessage('æˆ‘', msg, 'self');
        input.value = '';
    },
    
    addMessage(from, text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        const time = new Date().toLocaleTimeString();
        div.innerHTML = `<div style="font-size:11px;opacity:0.7;margin-bottom:4px">${from} Â· ${time}</div><div>${text}</div>`;
        const container = document.getElementById('messages');
        container.appendChild(div);
        div.scrollIntoView({behavior: 'smooth'});
    }
};

// æ¸…ç†æ—§æ•°æ®ï¼ˆå¯é€‰ï¼šåŠ è½½æ—¶æ¸…ç†5åˆ†é’Ÿå‰çš„æˆ¿é—´ï¼‰
window.addEventListener('load', async () => {
    // ç®€å•çš„æ¸…ç†é€»è¾‘ï¼ˆæ¼”ç¤ºç”¨ï¼Œå®é™…åº”åœ¨æœåŠ¡ç«¯è®¾ç½®è§„åˆ™ï¼‰
    try {
        const res = await fetch(`${CONFIG.signalServer}.json?shallow=true`);
        const keys = await res.json();
        if (keys) {
            Object.keys(keys).forEach(async key => {
                const data = await fetch(`${CONFIG.signalServer}/${key}.json`).then(r => r.json());
                if (data && Date.now() - data.timestamp > 10 * 60 * 1000) { // 10åˆ†é’Ÿè¿‡æœŸ
                    await fetch(`${CONFIG.signalServer}/${key}.json`, {method: 'DELETE'});
                }
            });
        }
    } catch(e) {}
});
</script>

</body>
</html>
