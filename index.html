<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Secure Room</title>
    <style>
        :root{--bg:#1e1e2e;--bg2:#252535;--text:#cdd6f4;--sub:#9399b6;--accent:#89b4fa;--err:#f38ba8;--ok:#a6e3a1}
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
        body{background:var(--bg);color:var(--text);height:100dvh;overflow:hidden}
        .hidden{display:none!important}
        
        #login{height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
        .box{background:var(--bg2);padding:30px;border-radius:12px;width:100%;max-width:400px;border:1px solid #333}
        h1{font-size:22px;margin-bottom:6px;color:#f5e0dc}
        .sub{color:var(--sub);font-size:13px;margin-bottom:20px}
        input{width:100%;padding:12px;margin:6px 0;background:#1e1e2e;border:1px solid #444;border-radius:8px;color:var(--text);font-size:14px}
        input:focus{outline:none;border-color:var(--accent)}
        button{width:100%;padding:12px;margin-top:10px;background:var(--accent);border:none;border-radius:8px;color:var(--bg);font-weight:bold;cursor:pointer}
        button:disabled{opacity:.5;cursor:not-allowed}
        .error{color:var(--err);font-size:12px;margin-top:8px;text-align:center}
        
        #chat{height:100%;display:flex;flex-direction:column}
        header{padding:12px 16px;background:var(--bg2);border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}
        .info h2{font-size:16px}
        .meta{font-size:11px;color:var(--sub);margin-top:2px}
        .status{width:8px;height:8px;border-radius:50%;background:var(--err);display:inline-block;margin-right:4px}
        .status.on{background:var(--ok);box-shadow:0 0 8px var(--ok)}
        .actions{display:flex;gap:8px}
        .icon-btn{padding:6px 12px;background:#333;border:1px solid #444;border-radius:6px;color:var(--text);font-size:12px;cursor:pointer}
        
        #messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
        .msg{max-width:85%;padding:10px 14px;border-radius:10px;font-size:14px;line-height:1.4;word-break:break-word}
        .msg.self{align-self:flex-end;background:var(--accent);color:var(--bg)}
        .msg.other{align-self:flex-start;background:var(--bg2);border:1px solid #444}
        .msg.sys{align-self:center;color:var(--sub);font-size:12px;font-style:italic}
        .msg-hd{font-size:11px;opacity:.7;margin-bottom:2px;display:flex;justify-content:space-between;gap:8px}
        
        #input{display:flex;padding:12px;gap:8px;background:var(--bg2);border-top:1px solid #333}
        #input input{flex:1;margin:0}
        #input button{width:auto;padding:12px 20px;margin:0}
        
        #loading{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
        .spin{width:40px;height:40px;border:3px solid #333;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .load-text{color:var(--sub);font-size:13px;margin-top:8px}
        
        #diag{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;flex-direction:column}
        #diag header{flex-shrink:0}
        #log{flex:1;overflow-y:auto;padding:12px;font-family:monospace;font-size:12px;line-height:1.5;background:#0f0f15;color:#a6e3a1}
        .log-e{color:var(--err)}.log-w{color:var(--warn)}.log-i{color:var(--accent)}
        .ctrl{padding:12px;display:flex;gap:8px;flex-wrap:wrap}
        .ctrl button{flex:1;min-width:100px;margin:0;font-size:12px}
    </style>
</head>
<body>
    <div id="login">
        <div class="box">
            <h1>ğŸ” Secure Room</h1>
            <div class="sub">ç«¯åˆ°ç«¯åŠ å¯†èŠå¤©</div>
            
            <input type="text" id="room" placeholder="æˆ¿é—´å" autocomplete="off">
            <input type="password" id="pwd" placeholder="å¯†ç " autocomplete="new-password">
            <input type="text" id="name" placeholder="æ˜µç§°" value="User" maxlength="12">
            
            <button onclick="App.join()" id="joinBtn">åŠ å…¥æˆ¿é—´</button>
            <div class="error" id="err"></div>
            
            <div style="margin-top:16px;font-size:11px;color:var(--sub);text-align:center">
                <button class="icon-btn" onclick="Diag.toggle()" style="width:auto;padding:4px 8px">ğŸ” è¯Šæ–­ç½‘ç»œ</button>
            </div>
        </div>
    </div>

    <div id="chat" class="hidden">
        <header>
            <div class="info">
                <h2 id="roomName">Room</h2>
                <div class="meta"><span class="status" id="status"></span><span id="peer">ç¦»çº¿</span></div>
            </div>
            <div class="actions">
                <button class="icon-btn" onclick="App.toggleDiag()">è¯Šæ–­</button>
                <button class="icon-btn" onclick="App.leave()">é€€å‡º</button>
            </div>
        </header>
        <div id="messages"></div>
        <div id="input">
            <input type="text" id="msg" placeholder="æ¶ˆæ¯..." maxlength="500" onkeypress="if(event.key==='Enter')App.send()">
            <button onclick="App.send()" id="sendBtn">å‘é€</button>
        </div>
    </div>

    <div id="loading" class="hidden">
        <div class="spin"></div>
        <div>è¿æ¥ä¸­...</div>
        <div class="load-text" id="loadDetail">åˆå§‹åŒ–</div>
        <button onclick="App.cancel()" style="margin-top:20px;width:auto;padding:8px 16px;background:#333;color:var(--text)">å–æ¶ˆ</button>
    </div>

    <div id="diag" class="hidden">
        <header>
            <h3>ç½‘ç»œè¯Šæ–­</h3>
            <button class="icon-btn" onclick="Diag.toggle()">å…³é—­</button>
        </header>
        <div id="log"></div>
        <div class="ctrl">
            <button onclick="Diag.net()">æ£€æµ‹ç½‘ç»œ</button>
            <button onclick="Diag.turn()">æµ‹è¯•TURN</button>
            <button onclick="Diag.clear()">æ¸…ç©º</button>
        </div>
    </div>

    <script type="module">
        const CONFIG = {
            MAX_RETRIES: 2,
            TIMEOUT: 15000,
            RELAYS: [
                'wss://relay.damus.io',
                'wss://nos.lol',
                'wss://relay.nostr.band'
            ],
            TURN_SERVERS: [
                { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
                { urls: 'turn:relay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
                { urls: 'turn:turn.anyfirewall.com:443?transport=tcp', username: 'webrtc', credential: 'webrtc' }
            ],
            STUN: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        class Crypto {
            static async deriveKey(pwd, salt) {
                const enc = new TextEncoder();
                const mat = await window.crypto.subtle.importKey('raw', enc.encode(pwd), 'PBKDF2', false, ['deriveKey']);
                return window.crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: enc.encode(salt), iterations: 100000, hash: 'SHA-256' },
                    mat, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
                );
            }

            static async encrypt(text, key) {
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const data = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(text));
                const buf = new Uint8Array(iv.length + data.byteLength);
                buf.set(iv); buf.set(new Uint8Array(data), iv.length);
                return btoa(String.fromCharCode(...buf));
            }

            static async decrypt(b64, key) {
                try {
                    const buf = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
                    const data = await window.crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: buf.slice(0, 12) }, key, buf.slice(12)
                    );
                    return new TextDecoder().decode(data);
                } catch { return null; }
            }

            static async fingerprint(pwd) {
                const enc = new TextEncoder();
                const mat = await window.crypto.subtle.importKey('raw', enc.encode(pwd), 'PBKDF2', false, ['deriveBits']);
                const bits = await window.crypto.subtle.deriveBits(
                    { name: 'PBKDF2', salt: enc.encode('fp'), iterations: 1000, hash: 'SHA-256' }, mat, 64
                );
                return Array.from(new Uint8Array(bits)).map(b => b.toString(16).padStart(2, '0')).join('');
            }
        }

        class Network {
            static async testTURN() {
                Diag.log('æµ‹è¯•TURNä¸­ç»§...', 'i');
                const pc = new RTCPeerConnection({ 
                    iceServers: CONFIG.TURN_SERVERS, 
                    iceTransportPolicy: 'relay' 
                });
                
                let relay = false;
                pc.onicecandidate = (e) => {
                    if (e.candidate?.candidate.includes('typ relay')) {
                        relay = true;
                        Diag.log('âœ“ TURNå¯ç”¨: ' + e.candidate.candidate.split(' ')[4], 'ok');
                    }
                };
                
                try {
                    pc.createDataChannel('test');
                    await pc.setLocalDescription(await pc.createOffer());
                    await new Promise((r, j) => setTimeout(() => relay ? r() : j(), 5000));
                    return true;
                } catch {
                    Diag.log('âœ— TURNä¸­ç»§å¤±è´¥', 'e');
                    return false;
                } finally {
                    pc.close();
                }
            }

            static async connect(roomId, key, onMsg, onPeer) {
                const { joinRoom } = await import('https://cdn.jsdelivr.net/npm/trystero@0.20.0/+esm');
                
                const room = joinRoom({
                    appId: 'srl-'+roomId.slice(0,8),
                    relayUrls: CONFIG.RELAYS,
                    password: roomId,
                    maxPeers: 6,
                    rtcConfig: {
                        iceServers: [...CONFIG.STUN, ...CONFIG.TURN_SERVERS],
                        iceTransportPolicy: 'all'
                    }
                }, roomId);

                const [send, recv] = room.makeAction('m');
                recv((data, pid) => onMsg(data, pid));
                room.onPeerJoin(pid => onPeer(pid, true));
                room.onPeerLeave(pid => onPeer(pid, false));
                
                return { room, send };
            }
        }

        const Diag = {
            toggle: () => document.getElementById('diag').classList.toggle('hidden'),
            log: (m, t='i') => {
                const el = document.getElementById('log');
                const c = {e:'log-e',w:'log-w',ok:'log-i'}[t] || '';
                el.innerHTML += `<div class="${c}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
                el.scrollTop = el.scrollHeight;
            },
            clear: () => document.getElementById('log').innerHTML = '',
            net: () => {
                Diag.log(`ç½‘ç»œçŠ¶æ€: ${navigator.onLine?'åœ¨çº¿':'ç¦»çº¿'}`, navigator.onLine?'ok':'e');
                const c = navigator.connection;
                if (c) Diag.log(`ç±»å‹: ${c.effectiveType}, å»¶è¿Ÿ: ${c.rtt}ms`);
            },
            turn: () => Network.testTURN()
        };

        const App = {
            key: null,
            fp: '',
            room: null,
            sendMsg: null,
            peers: new Set(),
            cancelFlag: false,

            async join() {
                const r = document.getElementById('room').value.trim();
                const p = document.getElementById('pwd').value;
                const n = document.getElementById('name').value.trim() || 'Anon';
                
                if (!r || !p) return this.showErr('å¡«å†™æˆ¿é—´å’Œå¯†ç ');

                this.cancelFlag = false;
                this.showLoading('ç”Ÿæˆå¯†é’¥...');
                
                try {
                    const [key, fp] = await Promise.all([
                        Crypto.deriveKey(p, r),
                        Crypto.fingerprint(p + r)
                    ]);
                    this.key = key;
                    this.fp = fp.slice(0, 8);
                    this.myName = n;
                    this.roomName = r;

                    if (this.cancelFlag) return;
                    this.showLoading('æµ‹è¯•ç½‘ç»œ...');
                    
                    const hasTURN = await Promise.race([
                        Network.testTURN(),
                        new Promise(r => setTimeout(() => r(false), 3000))
                    ]);

                    if (this.cancelFlag) return;
                    
                    if (!hasTURN) {
                        this.hideLoading();
                        alert('TURNä¸­ç»§è¿æ¥å¤±è´¥ï¼Œæ— æ³•å»ºç«‹åŠ å¯†é€šé“ã€‚\nè¯·æ£€æŸ¥é˜²ç«å¢™è®¾ç½®æˆ–æ›´æ¢ç½‘ç»œç¯å¢ƒã€‚');
                        return;
                    }

                    await this.connectNetwork();
                } catch (e) {
                    this.showErr('åˆå§‹åŒ–å¤±è´¥: ' + e.message);
                    this.hideLoading();
                }
            },

            async connectNetwork() {
                for (let i = 0; i < CONFIG.MAX_RETRIES; i++) {
                    if (this.cancelFlag) return;
                    this.showLoading(`è¿æ¥ä¸­ (${i+1}/${CONFIG.MAX_RETRIES})...`);
                    
                    try {
                        const conn = await Promise.race([
                            Network.connect(this.fp, this.key, this.handleMsg.bind(this), this.handlePeer.bind(this)),
                            new Promise((_, r) => setTimeout(() => r(new Error('è¶…æ—¶')), CONFIG.TIMEOUT))
                        ]);
                        
                        if (this.cancelFlag) {
                            conn.room.leave();
                            return;
                        }
                        
                        this.room = conn.room;
                        this.sendMsg = conn.send;
                        return this.enterRoom();
                    } catch (e) {
                        Diag.log(`å°è¯•${i+1}å¤±è´¥: ${e.message}`, 'e');
                        if (i < CONFIG.MAX_RETRIES - 1) await new Promise(r => setTimeout(r, 2000));
                    }
                }
                
                this.hideLoading();
                alert('è¿æ¥å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°æˆ¿é—´ã€‚\nå¯èƒ½åŸå› ï¼š\n1. TURNæœåŠ¡å™¨ä¸å¯ç”¨\n2. ç½‘ç»œé˜²ç«å¢™é˜»æ­¢\n3. æˆ¿é—´ä¸å­˜åœ¨\n\nè¯·æ£€æŸ¥è¯Šæ–­ä¿¡æ¯æˆ–ç¨åé‡è¯•ã€‚');
            },

            enterRoom() {
                this.hideLoading();
                document.getElementById('login').classList.add('hidden');
                document.getElementById('chat').classList.remove('hidden');
                document.getElementById('roomName').textContent = this.roomName;
                this.updateStatus();
                this.addMsg('ç³»ç»Ÿ', `å·²è¿æ¥æˆ¿é—´ #${this.fp}`, 'sys');
            },

            async handleMsg(data, pid) {
                if (!data.c) return;
                const txt = await Crypto.decrypt(data.c, this.key);
                if (!txt) return;
                try {
                    const m = JSON.parse(txt);
                    if (m.n !== this.myName) {
                        this.addMsg(m.n, m.t, 'other', m.f);
                    }
                } catch {}
            },

            handlePeer(pid, join) {
                if (join) this.peers.add(pid);
                else this.peers.delete(pid);
                this.updateStatus();
                if (join) this.addMsg('ç³»ç»Ÿ', 'æ–°æˆå‘˜åŠ å…¥', 'sys');
            },

            async send() {
                const inp = document.getElementById('msg');
                const t = inp.value.trim();
                if (!t) return;
                
                if (!this.sendMsg) {
                    alert('æœªè¿æ¥åˆ°æˆ¿é—´');
                    return;
                }
                
                const data = { n: this.myName, t, f: this.fp };
                const enc = await Crypto.encrypt(JSON.stringify(data), this.key);
                this.sendMsg({ c: enc });
                this.addMsg(this.myName, t, 'self');
                inp.value = '';
            },

            addMsg(user, text, type, fp='') {
                const d = document.createElement('div');
                d.className = `msg ${type}`;
                const time = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
                const sub = type==='sys' ? '' : `<div class="msg-hd"><span>${user} ${fp?'#'+fp.slice(0,4):''}</span><span>${time}</span></div>`;
                d.innerHTML = sub + (type==='sys'?text:this.escape(text));
                document.getElementById('messages').appendChild(d);
                d.scrollIntoView();
            },

            updateStatus() {
                const s = document.getElementById('status');
                const p = document.getElementById('peer');
                const n = this.peers.size;
                s.className = n > 0 ? 'status on' : 'status';
                p.textContent = n > 0 ? `${n+1}äººåœ¨çº¿` : 'ç­‰å¾…è¿æ¥';
            },

            escape(t) {
                const d = document.createElement('div');
                d.textContent = t;
                return d.innerHTML;
            },

            showLoading(t) {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('loadDetail').textContent = t;
            },
            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            },
            cancel() {
                this.cancelFlag = true;
                this.hideLoading();
            },
            showErr(e) {
                document.getElementById('err').textContent = e;
                setTimeout(() => document.getElementById('err').textContent = '', 3000);
            },
            leave() {
                if (confirm('é€€å‡ºï¼Ÿ')) location.reload();
            },
            toggleDiag() {
                Diag.toggle();
            }
        };

        window.App = App;
        window.Diag = Diag;
    </script>
</body>
</html>
