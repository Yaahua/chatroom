<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Secure Room</title>
    <style>
        :root{--bg:#1e1e2e;--bg2:#252535;--text:#cdd6f4;--sub:#9399b6;--accent:#89b4fa;--err:#f38ba8;--ok:#a6e3a1;--warn:#f9e2af}
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
        body{background:var(--bg);color:var(--text);height:100dvh;overflow:hidden}
        .hidden{display:none!important}
        
        #login{height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
        .box{background:var(--bg2);padding:30px;border-radius:12px;width:100%;max-width:400px;border:1px solid #333}
        h1{font-size:22px;margin-bottom:6px;color:#f5e0dc}
        .sub{color:var(--sub);font-size:13px;margin-bottom:20px}
        input{width:100%;padding:12px;margin:6px 0;background:#1e1e2e;border:1px solid #444;border-radius:8px;color:var(--text);font-size:14px}
        input:focus{outline:none;border-color:var(--accent)}
        button{width:100%;padding:12px;margin-top:10px;background:var(--accent);border:none;border-radius:8px;color:var(--bg);font-weight:bold;cursor:pointer}
        button:disabled{opacity:.5;cursor:not-allowed}
        .error{color:var(--err);font-size:12px;margin-top:8px;text-align:center}
        
        #chat{height:100%;display:flex;flex-direction:column}
        header{padding:12px 16px;background:var(--bg2);border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}
        .info h2{font-size:16px}
        .meta{font-size:11px;color:var(--sub);margin-top:2px}
        .status{width:8px;height:8px;border-radius:50%;background:var(--err);display:inline-block;margin-right:4px}
        .status.on{background:var(--ok);box-shadow:0 0 8px var(--ok)}
        .status.relay{background:var(--warn)} /* æ–°å¢ï¼šTURNä¸­ç»§çŠ¶æ€ */
        .actions{display:flex;gap:8px}
        .icon-btn{padding:6px 12px;background:#333;border:1px solid #444;border-radius:6px;color:var(--text);font-size:12px;cursor:pointer}
        
        #messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
        .msg{max-width:85%;padding:10px 14px;border-radius:10px;font-size:14px;line-height:1.4;word-break:break-word}
        .msg.self{align-self:flex-end;background:var(--accent);color:var(--bg)}
        .msg.other{align-self:flex-start;background:var(--bg2);border:1px solid #444}
        .msg.sys{align-self:center;color:var(--sub);font-size:12px;font-style:italic}
        .msg-hd{font-size:11px;opacity:.7;margin-bottom:2px;display:flex;justify-content:space-between;gap:8px}
        
        #input{display:flex;padding:12px;gap:8px;background:var(--bg2);border-top:1px solid #333}
        #input input{flex:1;margin:0}
        #input button{width:auto;padding:12px 20px;margin:0}
        
        #loading{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
        .spin{width:40px;height:40px;border:3px solid #333;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .load-text{color:var(--sub);font-size:13px;margin-top:8px}
        
        #diag{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;flex-direction:column}
        #diag header{flex-shrink:0}
        #log{flex:1;overflow-y:auto;padding:12px;font-family:monospace;font-size:12px;line-height:1.5;background:#0f0f15;color:#a6e3a1}
        .log-e{color:var(--err)}.log-w{color:var(--warn)}.log-i{color:var(--accent)}.log-s{color:var(--ok)}
        .ctrl{padding:12px;display:flex;gap:8px;flex-wrap:wrap}
        .ctrl button{flex:1;min-width:100px;margin:0;font-size:12px}
    </style>
</head>
<body>
    <div id="login">
        <div class="box">
            <h1>ğŸ” Secure Room</h1>
            <div class="sub">ç«¯åˆ°ç«¯åŠ å¯†èŠå¤© Â· å›½å†…ä¼˜åŒ–ç‰ˆ</div>
            
            <input type="text" id="room" placeholder="æˆ¿é—´å" autocomplete="off">
            <input type="password" id="pwd" placeholder="å¯†ç " autocomplete="new-password">
            <input type="text" id="name" placeholder="æ˜µç§°" value="User" maxlength="12">
            
            <button onclick="App.join()" id="joinBtn">åŠ å…¥æˆ¿é—´</button>
            <div class="error" id="err"></div>
            
            <div style="margin-top:16px;font-size:11px;color:var(--sub);text-align:center">
                <button class="icon-btn" onclick="Diag.toggle()" style="width:auto;padding:4px 8px">ğŸ” è¯Šæ–­ç½‘ç»œ</button>
            </div>
        </div>
    </div>

    <div id="chat" class="hidden">
        <header>
            <div class="info">
                <h2 id="roomName">Room</h2>
                <div class="meta">
                    <span class="status" id="status"></span>
                    <span id="peer">ç¦»çº¿</span>
                    <span id="connType" style="margin-left:8px;color:var(--warn)"></span>
                </div>
            </div>
            <div class="actions">
                <button class="icon-btn" onclick="App.toggleDiag()">è¯Šæ–­</button>
                <button class="icon-btn" onclick="App.leave()">é€€å‡º</button>
            </div>
        </header>
        <div id="messages"></div>
        <div id="input">
            <input type="text" id="msg" placeholder="æ¶ˆæ¯..." maxlength="500" onkeypress="if(event.key==='Enter')App.send()">
            <button onclick="App.send()" id="sendBtn">å‘é€</button>
        </div>
    </div>

    <div id="loading" class="hidden">
        <div class="spin"></div>
        <div>è¿æ¥ä¸­...</div>
        <div class="load-text" id="loadDetail">åˆå§‹åŒ–</div>
        <button onclick="App.cancel()" style="margin-top:20px;width:auto;padding:8px 16px;background:#333;color:var(--text)">å–æ¶ˆ</button>
    </div>

    <div id="diag" class="hidden">
        <header>
            <h3>ç½‘ç»œè¯Šæ–­</h3>
            <button class="icon-btn" onclick="Diag.toggle()">å…³é—­</button>
        </header>
        <div id="log"></div>
        <div class="ctrl">
            <button onclick="Diag.net()">æ£€æµ‹ç½‘ç»œ</button>
            <button onclick="Diag.turn()">æµ‹è¯•TURN</button>
            <button onclick="Diag.clear()">æ¸…ç©º</button>
        </div>
    </div>

    <script type="module">
        // ==========================================
        // é…ç½®åŒºï¼šå›½å†…ç½‘ç»œä¼˜åŒ–ï¼ˆæ–¹æ¡ˆäºŒ + æ–¹æ¡ˆä¸‰ï¼‰
        // ==========================================
        const CONFIG = {
            MAX_RETRIES: 3,
            TIMEOUT: 20000,  // å›½å†…ç½‘ç»œå»¶è¿Ÿé«˜ï¼Œå»¶é•¿è¶…æ—¶
            
            // Nostr ä¸­ç»§ï¼ˆä¿¡ä»¤æœåŠ¡å™¨ï¼‰
            RELAYS: [
                'wss://relay.damus.io',
                'wss://nos.lol',
                'wss://relay.nostr.band'
            ],
            
            // æ–¹æ¡ˆä¸‰ï¼šå¢åŠ  STUN æ•°é‡ï¼Œæœ€å¤§åŒ– P2P ç›´è¿æˆåŠŸç‡
            // åŒ…å« Google å…¨çƒèŠ‚ç‚¹ + Cloudflare + å›½å†…å°ç±³èŠ‚ç‚¹
            STUN: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun.cloudflare.com:3478' },
                { urls: 'stun:stun.miwifi.com' }  // å›½å†…èŠ‚ç‚¹ï¼Œå»¶è¿Ÿä½
            ],
            
            // æ–¹æ¡ˆäºŒï¼šMetered TURN å›½å†…ä¼˜åŒ–é…ç½®
            // ä¼˜å…ˆçº§ï¼šTCP 443 > TCP 80 > UDP
            TURN_SERVERS: [
                {
                    // ä¸»ï¼šTCP 443ï¼ˆä¼ªè£… HTTPSï¼Œç©¿é€ä¼ä¸š/æ ¡å›­é˜²ç«å¢™ï¼‰
                    urls: 'turn:standard.relay.metered.ca:443?transport=tcp',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    // å¤‡ï¼šTCP 80ï¼ˆæä¸¥æ ¼é˜²ç«å¢™ç¯å¢ƒï¼ŒHTTP ç«¯å£é€šå¸¸å¼€æ”¾ï¼‰
                    urls: 'turn:standard.relay.metered.ca:80?transport=tcp',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    // åº”æ€¥ï¼šUDPï¼ˆä½å»¶è¿Ÿï¼Œå¦‚æœç½‘ç»œå…è®¸ï¼‰
                    urls: 'turn:standard.relay.metered.ca:80?transport=udp',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ]
        };

        // ==========================================
        // åŠ å¯†æ¨¡å—ï¼ˆä¿æŒä¸å˜ï¼‰
        // ==========================================
        class Crypto {
            static async deriveKey(pwd, salt) {
                const enc = new TextEncoder();
                const mat = await window.crypto.subtle.importKey('raw', enc.encode(pwd), 'PBKDF2', false, ['deriveKey']);
                return window.crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: enc.encode(salt), iterations: 100000, hash: 'SHA-256' },
                    mat, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
                );
            }

            static async encrypt(text, key) {
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const data = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(text));
                const buf = new Uint8Array(iv.length + data.byteLength);
                buf.set(iv); buf.set(new Uint8Array(data), iv.length);
                return btoa(String.fromCharCode(...buf));
            }

            static async decrypt(b64, key) {
                try {
                    const buf = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
                    const data = await window.crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: buf.slice(0, 12) }, key, buf.slice(12)
                    );
                    return new TextDecoder().decode(data);
                } catch { return null; }
            }

            static async fingerprint(pwd) {
                const enc = new TextEncoder();
                const mat = await window.crypto.subtle.importKey('raw', enc.encode(pwd), 'PBKDF2', false, ['deriveBits']);
                const bits = await window.crypto.subtle.deriveBits(
                    { name: 'PBKDF2', salt: enc.encode('fp'), iterations: 1000, hash: 'SHA-256' }, mat, 64
                );
                return Array.from(new Uint8Array(bits)).map(b => b.toString(16).padStart(2, '0')).join('');
            }
        }

        // ==========================================
        // ç½‘ç»œæ¨¡å—ï¼šå›½å†…ä¼˜åŒ–ç‰ˆ
        // ==========================================
        class Network {
            // æµ‹è¯• TURN å¯ç”¨æ€§
            static async testTURN() {
                Diag.log('æµ‹è¯• TURN ä¸­ç»§...', 'i');
                
                // ä¼˜å…ˆæµ‹è¯• TCP 443ï¼ˆå›½å†…æœ€å¯èƒ½é€šï¼‰
                const testServer = CONFIG.TURN_SERVERS[0];
                const pc = new RTCPeerConnection({ 
                    iceServers: [testServer], 
                    iceTransportPolicy: 'relay' 
                });
                
                let relayCandidate = null;
                pc.onicecandidate = (e) => {
                    if (e.candidate?.candidate.includes('typ relay')) {
                        relayCandidate = e.candidate;
                        Diag.log('âœ“ TURN å¯ç”¨: ' + e.candidate.address, 's');
                    }
                };
                
                try {
                    pc.createDataChannel('test');
                    await pc.setLocalDescription(await pc.createOffer());
                    await new Promise((r, j) => setTimeout(() => relayCandidate ? r() : j(), 5000));
                    return true;
                } catch {
                    Diag.log('âœ— TURN ä¸­ç»§å¤±è´¥', 'e');
                    return false;
                } finally {
                    pc.close();
                }
            }

            // ä¸»è¿æ¥å‡½æ•°ï¼šä¼˜åŒ– RTC é…ç½®
            static async connect(roomId, key, onMsg, onPeer) {
                const { joinRoom } = await import('https://cdn.jsdelivr.net/npm/trystero@0.20.0/+esm');
                
                // å›½å†…ç½‘ç»œä¼˜åŒ–é…ç½®
                const rtcConfig = {
                    // ICE æœåŠ¡å™¨é¡ºåºï¼šSTUN ä¼˜å…ˆï¼ˆå°è¯•ç›´è¿ï¼‰â†’ TURNï¼ˆä¸­ç»§å…œåº•ï¼‰
                    iceServers: [
                        ...CONFIG.STUN,           // æ–¹æ¡ˆä¸‰ï¼šå…ˆå°è¯• P2P ç›´è¿
                        ...CONFIG.TURN_SERVERS    // æ–¹æ¡ˆäºŒï¼šå¤±è´¥æ—¶ fallback åˆ° TURN
                    ],
                    
                    // å…³é”®ï¼šå…è®¸æ‰€æœ‰ä¼ è¾“æ–¹å¼ï¼Œä¼˜å…ˆå°è¯•ç›´è¿ï¼Œå¤±è´¥è‡ªåŠ¨åˆ‡æ¢ TURN
                    iceTransportPolicy: 'all',
                    
                    // é¢„æ”¶é›†å€™é€‰ï¼ŒåŠ å¿«è¿æ¥å»ºç«‹ï¼ˆå›½å†…ç½‘ç»œæ…¢ï¼Œéœ€è¦æå‰æ”¶é›†ï¼‰
                    iceCandidatePoolSize: 10,
                    
                    // å¤šè·¯å¤ç”¨ï¼Œå‡å°‘ç«¯å£æ¶ˆè€—ï¼ˆå›½å†…é˜²ç«å¢™å¯¹å¤šç«¯å£æ•æ„Ÿï¼‰
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require'
                };

                Diag.log('åˆ›å»ºæˆ¿é—´...', 'i');
                const room = joinRoom({
                    appId: 'srl-'+roomId.slice(0,8),
                    relayUrls: CONFIG.RELAYS,
                    password: roomId,
                    maxPeers: 6,
                    rtcConfig: rtcConfig
                }, roomId);

                const [send, recv] = room.makeAction('m');
                recv((data, pid) => onMsg(data, pid));
                
                // ç›‘æ§è¿æ¥ç±»å‹ï¼ˆP2P è¿˜æ˜¯ TURNï¼‰
                room.onPeerJoin(pid => {
                    onPeer(pid, true);
                    this.monitorConnection(room, pid);
                });
                room.onPeerLeave(pid => onPeer(pid, false));
                
                return { room, send };
            }

            // ç›‘æ§ ICE è¿æ¥çŠ¶æ€ï¼ˆè¯Šæ–­ç”¨ï¼‰
            static monitorConnection(room, peerId) {
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾… RTCPeerConnection å»ºç«‹
                setTimeout(async () => {
                    try {
                        // è·å–åº•å±‚ RTCPeerConnectionï¼ˆTrystero å†…éƒ¨ç»“æ„ï¼‰
                        const pcs = room._pcs || room.connections;
                        if (!pcs) return;
                        
                        const pc = pcs.get?.(peerId) || pcs[peerId];
                        if (!pc) return;

                        // ç›‘å¬çŠ¶æ€å˜åŒ–
                        pc.oniceconnectionstatechange = () => {
                            const state = pc.iceConnectionState;
                            Diag.log(`Peer ${peerId.slice(0,6)} ICE: ${state}`, 
                                state === 'connected' ? 's' : state === 'failed' ? 'e' : 'i');
                        };

                        // æ£€æµ‹è¿æ¥ç±»å‹ï¼ˆç›´è¿ vs ä¸­ç»§ï¼‰
                        setTimeout(async () => {
                            const stats = await pc.getStats();
                            let connType = 'unknown';
                            
                            stats.forEach(report => {
                                if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                                    const local = stats.get(report.localCandidateId);
                                    const remote = stats.get(report.remoteCandidateId);
                                    
                                    if (local && remote) {
                                        if (local.candidateType === 'relay' || remote.candidateType === 'relay') {
                                            connType = 'relay'; // TURN ä¸­ç»§
                                        } else if (local.candidateType === 'srflx' || remote.candidateType === 'srflx') {
                                            connType = 'srflx'; // å…¬ç½‘ P2P
                                        } else if (local.candidateType === 'host' && remote.candidateType === 'host') {
                                            connType = 'host'; // å±€åŸŸç½‘ç›´è¿
                                        }
                                    }
                                }
                            });

                            // æ›´æ–° UI æ˜¾ç¤ºè¿æ¥ç±»å‹
                            App.updateConnType(connType);
                            
                            if (connType === 'relay') {
                                Diag.log('é€šè¿‡ TURN ä¸­ç»§è¿æ¥ï¼ˆç©¿è¶Šé˜²ç«å¢™ï¼‰', 'w');
                            } else if (connType === 'host') {
                                Diag.log('å±€åŸŸç½‘ç›´è¿ï¼ˆæœ€ä¼˜ï¼‰', 's');
                            } else {
                                Diag.log('å…¬ç½‘ P2P ç›´è¿', 's');
                            }
                        }, 3000);
                        
                    } catch (e) {
                        Diag.log('ç›‘æ§åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'e');
                    }
                }, 1000);
            }
        }

        // ==========================================
        // è¯Šæ–­æ¨¡å—
        // ==========================================
        const Diag = {
            toggle: () => document.getElementById('diag').classList.toggle('hidden'),
            log: (m, t='i') => {
                const el = document.getElementById('log');
                const c = {e:'log-e', w:'log-w', i:'log-i', s:'log-s'}[t] || '';
                el.innerHTML += `<div class="${c}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
                el.scrollTop = el.scrollHeight;
            },
            clear: () => document.getElementById('log').innerHTML = '',
            net: () => {
                Diag.log(`ç½‘ç»œçŠ¶æ€: ${navigator.onLine?'åœ¨çº¿':'ç¦»çº¿'}`, navigator.onLine?'s':'e');
                const c = navigator.connection;
                if (c) {
                    Diag.log(`ç±»å‹: ${c.effectiveType}, ä¸‹è¡Œ: ${c.downlink}Mbps, RTT: ${c.rtt}ms`);
                }
            },
            turn: () => Network.testTURN()
        };

        // ==========================================
        // åº”ç”¨ä¸»é€»è¾‘
        // ==========================================
        const App = {
            key: null,
            fp: '',
            room: null,
            sendMsg: null,
            peers: new Set(),
            cancelFlag: false,
            connType: 'unknown', // è¿æ¥ç±»å‹

            async join() {
                const r = document.getElementById('room').value.trim();
                const p = document.getElementById('pwd').value;
                const n = document.getElementById('name').value.trim() || 'Anon';
                
                if (!r || !p) return this.showErr('å¡«å†™æˆ¿é—´å’Œå¯†ç ');

                this.cancelFlag = false;
                this.showLoading('ç”Ÿæˆå¯†é’¥...');
                
                try {
                    const [key, fp] = await Promise.all([
                        Crypto.deriveKey(p, r),
                        Crypto.fingerprint(p + r)
                    ]);
                    this.key = key;
                    this.fp = fp.slice(0, 8);
                    this.myName = n;
                    this.roomName = r;

                    if (this.cancelFlag) return;
                    this.showLoading('æµ‹è¯•ç½‘ç»œ...');
                    
                    // æµ‹è¯• TURN å¯ç”¨æ€§ï¼ˆå¯é€‰ï¼ŒåŠ å¿«è¿æ¥å¯è·³è¿‡ï¼‰
                    const hasTURN = await Promise.race([
                        Network.testTURN(),
                        new Promise(r => setTimeout(() => r(false), 3000))
                    ]);

                    if (this.cancelFlag) return;
                    
                    if (!hasTURN) {
                        Diag.log('TURN æµ‹è¯•æœªé€šè¿‡ï¼Œä»å°è¯•è¿æ¥...', 'w');
                        // ä¸é˜»æ–­ï¼Œç»§ç»­å°è¯•ï¼Œå¯èƒ½å®é™…èƒ½é€š
                    }

                    await this.connectNetwork();
                } catch (e) {
                    this.showErr('åˆå§‹åŒ–å¤±è´¥: ' + e.message);
                    this.hideLoading();
                }
            },

            async connectNetwork() {
                for (let i = 0; i < CONFIG.MAX_RETRIES; i++) {
                    if (this.cancelFlag) return;
                    this.showLoading(`è¿æ¥ä¸­ (${i+1}/${CONFIG.MAX_RETRIES})...`);
                    
                    try {
                        const conn = await Promise.race([
                            Network.connect(this.fp, this.key, this.handleMsg.bind(this), this.handlePeer.bind(this)),
                            new Promise((_, r) => setTimeout(() => r(new Error('è¶…æ—¶')), CONFIG.TIMEOUT))
                        ]);
                        
                        if (this.cancelFlag) {
                            conn.room.leave();
                            return;
                        }
                        
                        this.room = conn.room;
                        this.sendMsg = conn.send;
                        return this.enterRoom();
                    } catch (e) {
                        Diag.log(`å°è¯• ${i+1} å¤±è´¥: ${e.message}`, 'e');
                        if (i < CONFIG.MAX_RETRIES - 1) await new Promise(r => setTimeout(r, 2000));
                    }
                }
                
                this.hideLoading();
                alert('è¿æ¥å¤±è´¥ï¼šæ— æ³•å»ºç«‹ P2P è¿æ¥ã€‚\nå¯èƒ½åŸå› ï¼š\n1. é˜²ç«å¢™é˜»æ­¢ WebRTC\n2. TURN æœåŠ¡å™¨ä¸å¯è¾¾\n3. ç½‘ç»œç±»å‹ä¸å…¼å®¹ï¼ˆå¯¹ç§°å‹ NATï¼‰\n\nè¯·å°è¯•åˆ‡æ¢ç½‘ç»œï¼ˆå¦‚ 4G çƒ­ç‚¹ï¼‰æˆ–æ£€æŸ¥è¯Šæ–­ä¿¡æ¯ã€‚');
            },

            enterRoom() {
                this.hideLoading();
                document.getElementById('login').classList.add('hidden');
                document.getElementById('chat').classList.remove('hidden');
                document.getElementById('roomName').textContent = this.roomName;
                this.updateStatus();
                this.addMsg('ç³»ç»Ÿ', `å·²è¿æ¥æˆ¿é—´ #${this.fp}`, 'sys');
                this.addMsg('ç³»ç»Ÿ', 'ç­‰å¾…å…¶ä»–æˆå‘˜åŠ å…¥...', 'sys');
            },

            async handleMsg(data, pid) {
                if (!data.c) return;
                const txt = await Crypto.decrypt(data.c, this.key);
                if (!txt) return;
                try {
                    const m = JSON.parse(txt);
                    if (m.n !== this.myName) {
                        this.addMsg(m.n, m.t, 'other', m.f);
                    }
                } catch {}
            },

            handlePeer(pid, join) {
                if (join) this.peers.add(pid);
                else this.peers.delete(pid);
                this.updateStatus();
                if (join) this.addMsg('ç³»ç»Ÿ', 'æ–°æˆå‘˜åŠ å…¥', 'sys');
                else this.addMsg('ç³»ç»Ÿ', 'æˆå‘˜ç¦»å¼€', 'sys');
            },

            // æ›´æ–°è¿æ¥ç±»å‹æ˜¾ç¤ºï¼ˆæ–°å¢ï¼‰
            updateConnType(type) {
                this.connType = type;
                const el = document.getElementById('connType');
                const statusEl = document.getElementById('status');
                
                if (type === 'host') {
                    el.textContent = '[å±€åŸŸç½‘]';
                    el.style.color = 'var(--ok)';
                } else if (type === 'srflx') {
                    el.textContent = '[å…¬ç½‘ç›´è¿]';
                    el.style.color = 'var(--ok)';
                } else if (type === 'relay') {
                    el.textContent = '[ä¸­ç»§]';
                    el.style.color = 'var(--warn)';
                    statusEl.classList.add('relay');
                }
            },

            async send() {
                const inp = document.getElementById('msg');
                const t = inp.value.trim();
                if (!t) return;
                
                if (!this.sendMsg) {
                    alert('æœªè¿æ¥åˆ°æˆ¿é—´');
                    return;
                }
                
                const data = { n: this.myName, t, f: this.fp };
                const enc = await Crypto.encrypt(JSON.stringify(data), this.key);
                this.sendMsg({ c: enc });
                this.addMsg(this.myName, t, 'self');
                inp.value = '';
            },

            addMsg(user, text, type, fp='') {
                const d = document.createElement('div');
                d.className = `msg ${type}`;
                const time = new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
                const sub = type==='sys' ? '' : `<div class="msg-hd"><span>${user} ${fp?'#'+fp.slice(0,4):''}</span><span>${time}</span></div>`;
                d.innerHTML = sub + (type==='sys'?text:this.escape(text));
                document.getElementById('messages').appendChild(d);
                d.scrollIntoView();
            },

            updateStatus() {
                const s = document.getElementById('status');
                const p = document.getElementById('peer');
                const n = this.peers.size;
                s.className = n > 0 ? (this.connType === 'relay' ? 'status relay' : 'status on') : 'status';
                p.textContent = n > 0 ? `${n+1}äººåœ¨çº¿` : 'ç­‰å¾…è¿æ¥';
            },

            escape(t) {
                const d = document.createElement('div');
                d.textContent = t;
                return d.innerHTML;
            },

            showLoading(t) {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('loadDetail').textContent = t;
            },
            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            },
            cancel() {
                this.cancelFlag = true;
                this.hideLoading();
            },
            showErr(e) {
                document.getElementById('err').textContent = e;
                setTimeout(() => document.getElementById('err').textContent = '', 3000);
            },
            leave() {
                if (confirm('é€€å‡ºï¼Ÿ')) location.reload();
            },
            toggleDiag() {
                Diag.toggle();
            }
        };

        window.App = App;
        window.Diag = Diag;
    </script>
</body>
</html>
