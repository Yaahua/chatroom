<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero-TURN P2P Chat (Persistent)</title>
    <style>
        :root{--bg:#0f0f0f;--bg2:#1a1a1a;--text:#e0e0e0;--accent:#00d084;--err:#ff4757;--warn:#ffa502;--info:#3498db}
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
        body{background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
        .hidden{display:none!important}
        
        #setup{height:100%;display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column}
        .card{background:var(--bg2);padding:30px;border-radius:16px;max-width:500px;width:100%;border:1px solid #333}
        h1{font-size:24px;margin-bottom:10px;color:var(--accent)}
        .info{font-size:12px;color:#888;margin-bottom:20px;line-height:1.5}
        
        button{width:100%;padding:14px;margin:8px 0;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:bold;cursor:pointer;font-size:14px}
        button:hover{opacity:0.9;transform:translateY(-1px)}
        button.secondary{background:#333;color:var(--text)}
        button.small{width:auto;padding:8px 16px;font-size:12px}
        button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        
        textarea{width:100%;height:100px;padding:12px;background:#000;border:1px solid #444;border-radius:8px;color:var(--text);font-family:monospace;font-size:11px;margin:10px 0;resize:none}
        
        #chat{height:100%;display:flex;flex-direction:column;padding:20px}
        #status{padding:10px;background:var(--bg2);border-radius:8px;margin-bottom:10px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
        .badge{padding:4px 8px;border-radius:4px;font-size:11px;background:#333}
        .badge.direct{background:var(--accent);color:#000}
        .badge.failed{background:var(--err);color:#fff}
        .badge.local{background:var(--info);color:#fff}
        .badge.waiting{background:var(--warn);color:#000}
        
        #messages{flex:1;overflow-y:auto;padding:10px;background:#000;border-radius:8px;margin-bottom:10px;border:1px solid #333}
        .msg{margin:8px 0;padding:10px;background:var(--bg2);border-radius:8px;max-width:80%;word-break:break-all}
        .msg.self{margin-left:auto;background:rgba(0,208,132,0.2);border:1px solid var(--accent)}
        .msg.system{text-align:center;background:transparent;color:#666;font-size:12px;max-width:100%;padding:5px}
        .msg.error{background:rgba(255,71,87,0.1);border:1px solid var(--err);color:#ff4757}
        .msg .time{font-size:10px;color:#666;margin-top:4px}
        
        #input{display:flex;gap:10px}
        #input input{flex:1;padding:12px;background:var(--bg2);border:1px solid #444;border-radius:8px;color:var(--text)}
        #input button{width:auto;padding:12px 24px}
        
        .signal-panel{background:#000;border:1px solid #333;border-radius:8px;padding:15px;margin-bottom:15px}
        .signal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:5px}
        .short-code{font-size:28px;font-weight:bold;color:var(--accent);letter-spacing:6px;text-align:center;padding:15px;background:rgba(0,208,132,0.1);border-radius:4px;margin:10px 0;font-family:monospace;border:1px dashed var(--accent)}
        .code-info{font-size:11px;color:#666;text-align:center;margin-top:5px}
        
        .refresh-bar{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,165,2,0.1);border-radius:4px;margin-top:10px;font-size:12px}
        
        .input-group{display:flex;gap:10px;margin-top:10px}
        .input-group input{flex:1;padding:10px;background:#000;border:1px solid #444;border-radius:4px;color:var(--text);font-family:monospace;font-size:11px}
        .input-group button{width:auto;margin:0}
        
        .stats{font-size:10px;color:#666;margin-top:5px}
        
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:100;padding:20px}
        .modal-content{background:var(--bg2);padding:20px;border-radius:12px;max-width:500px;width:100%}
    </style>
</head>
<body>
    <!-- åˆå§‹è®¾ç½®ç•Œé¢ -->
    <div id="setup">
        <div class="card">
            <h1>ğŸ”® Zero-TURN P2P</h1>
            <div class="info">
                <strong>æŒä¹…åŒ–ç‰ˆæœ¬</strong><br>
                â€¢ é‚€è¯·ç é•¿æœŸæœ‰æ•ˆï¼ˆæ”¯æŒICE Restartï¼‰<br>
                â€¢ æ–­çº¿è‡ªåŠ¨é‡è¿<br>
                â€¢ åˆ·æ–°é¡µé¢ä¸ä¸¢å¤±ä¼šè¯<br>
                <span style="color:var(--warn)">æç¤ºï¼šå»ºè®®åŒæ–¹å°½å¿«å®Œæˆè¿æ¥</span>
            </div>
            
            <button onclick="App.createRoom()" id="createBtn">åˆ›å»ºæˆ¿é—´</button>
            <button class="secondary" onclick="App.joinRoom()">åŠ å…¥æˆ¿é—´</button>
            
            <div id="joinSection" class="hidden" style="margin-top:20px">
                <label style="font-size:12px;color:#888">è¾“å…¥6ä½æˆ¿é—´ç æˆ–ç²˜è´´å®Œæ•´é‚€è¯·ç ï¼š</label>
                <input type="text" id="joinCode" placeholder="å¦‚ï¼šABC123 æˆ–ç²˜è´´é•¿ç ..." style="width:100%;padding:12px;background:#000;border:1px solid #444;border-radius:8px;color:var(--text);margin:10px 0;text-transform:uppercase;font-family:monospace">
                <button onclick="App.connect()" id="connectBtn">è¿æ¥</button>
            </div>
        </div>
    </div>

    <!-- èŠå¤©ç•Œé¢ -->
    <div id="chat" class="hidden">
        <div id="status">
            <span>
                çŠ¶æ€: <span id="connStatus">åˆå§‹åŒ–...</span>
                <span id="connType" class="badge waiting" style="margin-left:10px">ç­‰å¾…è¿æ¥</span>
            </span>
            <button class="secondary small" onclick="App.disconnect()">æ–­å¼€</button>
        </div>
        
        <!-- ä¿¡ä»¤é¢æ¿ï¼ˆåˆ›å»ºè€…æ˜¾ç¤ºï¼‰ -->
        <div id="signalPanel" class="signal-panel hidden">
            <div class="signal-header">
                <strong>ğŸ“¡ é‚€è¯·ç ï¼ˆé•¿æœŸæœ‰æ•ˆï¼‰</strong>
                <span style="font-size:11px;color:#888" id="updateTime">åˆšåˆšæ›´æ–°</span>
            </div>
            
            <div class="short-code" id="shortCode">ç”Ÿæˆä¸­...</div>
            <div class="code-info">6ä½çŸ­ç  + å®Œæ•´SDPï¼ˆæ”¯æŒé‡å¤åˆ·æ–°ï¼‰</div>
            
            <button onclick="App.copyInvite()" style="width:100%;margin-top:10px">å¤åˆ¶å®Œæ•´é‚€è¯·ç </button>
            
            <div class="refresh-bar">
                <span>ICEå€™é€‰å·²ä¼˜åŒ–</span>
                <button class="small secondary" onclick="App.refreshOffer()" style="width:auto">å¼ºåˆ¶åˆ·æ–°</button>
            </div>
            
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #333">
                <label style="font-size:11px;color:#888">ç²˜è´´å¯¹æ–¹å‘æ¥çš„å“åº”ç ï¼š</label>
                <div class="input-group">
                    <input type="text" id="responseCode" placeholder="ç²˜è´´å“åº”ç åæŒ‰å›è½¦..." onkeypress="if(event.key==='Enter')App.completeConnection()">
                    <button onclick="App.completeConnection()" class="small">å®Œæˆ</button>
                </div>
            </div>
        </div>
        
        <!-- åŠ å…¥è€…é¢æ¿ -->
        <div id="joinerPanel" class="signal-panel hidden">
            <div class="signal-header">
                <strong>ğŸ”— ç­‰å¾…è¿æ¥ç¡®è®¤</strong>
            </div>
            <p style="font-size:12px;color:#888;margin-bottom:10px">è¯·å°†ä»¥ä¸‹å“åº”ç å‘é€ç»™é‚€è¯·æ–¹ï¼š</p>
            <textarea id="answerCode" readonly style="height:60px;font-size:10px"></textarea>
            <button onclick="App.copyAnswer()" style="width:100%;margin-top:10px">å¤åˆ¶å“åº”ç </button>
            <p style="font-size:11px;color:#666;margin-top:10px">ç­‰å¾…é‚€è¯·æ–¹å®Œæˆè¿æ¥...</p>
        </div>
        
        <div id="messages"></div>
        
        <div id="input" style="display:none">
            <input type="text" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="1000" onkeypress="if(event.key==='Enter')App.send()">
            <button onclick="App.send()">å‘é€</button>
        </div>
    </div>

    <script>
        // å†…è” LZ-String å‹ç¼©ç®—æ³•ï¼ˆé¿å…å¤–éƒ¨CDNä¾èµ–ï¼‰
        var LZString = {
            compress:function(uncompressed){if(uncompressed==null)return"";var i,value,context_dictionary={},context_dictionaryToCreate={},context_c="",context_wc="",context_w="",context_enlargeIn=2,context_dictSize=3,context_numBits=2,context_data=[],context_data_val=0,context_data_position=0,ii;for(ii=0;ii<uncompressed.length;ii+=1){value=uncompressed.charCodeAt(ii);for(i=0;i<8;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=value>>1}}context_enlargeIn=2;context_dictSize=3;context_numBits=2;context_dictionary={};context_dictionaryToCreate={};context_wc="";context_w="";context_c="";context_data_val=0;context_data_position=0;for(ii=0;ii<uncompressed.length;ii+=1){context_c=uncompressed.charAt(ii);if(!Object.prototype.hasOwnProperty.call(context_dictionary,context_c)){context_dictionary[context_c]=context_dictSize++;context_dictionaryToCreate[context_c]=true}else{context_dictionaryToCreate[context_c]=false}context_wc=context_w+context_c;if(Object.prototype.hasOwnProperty.call(context_dictionary,context_wc)){context_w=context_wc}else{if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}}value=context_w.charCodeAt(0);for(i=0;i<8;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=value>>1}}else{value=1;for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|value;if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=0}value=context_w.charCodeAt(0);for(i=0;i<16;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=value>>1}}context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++}delete context_dictionaryToCreate[context_w]}else{value=context_dictionary[context_w];for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=value>>1}}context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++}context_dictionary[context_wc]=context_dictSize++;context_w=String(context_c)}}if(context_w!==""){if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}}value=context_w.charCodeAt(0);for(i=0;i<8;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=value>>1}}else{value=1;for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|value;if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=0}value=context_w.charCodeAt(0);for(i=0;i<16;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=value>>1}}context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++}delete context_dictionaryToCreate[context_w]}else{value=context_dictionary[context_w];for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=value>>1}}context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++}}value=2;for(i=0;i<context_numBits;i++){context_data_val=(context_data_val<<1)|(value&1);if(context_data_position==15){context_data_position=0;context_data.push(String.fromCharCode(context_data_val));context_data_val=0}else{context_data_position++}value=value>>1}while(true){context_data_val=(context_data_val<<1);if(context_data_position==15){context_data.push(String.fromCharCode(context_data_val));break}else context_data_position++}return context_data.join("")},
            
            decompress:function(compressed){if(compressed==null)return"";if(compressed=="")return null;var dictionary={0:0,1:1,2:2},next=3,enlargeIn=4,numBits=3,result=[],dict={},i,w,bits,resb,maxpower,power,c,errorCount=0,currentPosition=0,data={val:compressed.charCodeAt(0),position:32768,index:1};for(i=0;i<3;i+=1)dict[i]=i;bits=0;maxpower=Math.pow(2,2);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=32768;data.val=compressed.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}switch(bits){case 0:bits=0;maxpower=Math.pow(2,8);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=32768;data.val=compressed.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}c=String.fromCharCode(bits);break;case 1:bits=0;maxpower=Math.pow(2,16);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=32768;data.val=compressed.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}c=String.fromCharCode(bits);break;case 2:return""}dictionary[3]=c;w=c;result.push(c);while(true){if(data.index>compressed.length)return"";bits=0;maxpower=Math.pow(2,numBits);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=32768;data.val=compressed.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}switch(bits){case 0:bits=0;maxpower=Math.pow(2,8);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=32768;data.val=compressed.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}dictionary[next++]=String.fromCharCode(bits);enlargeIn--;break;case 1:bits=0;maxpower=Math.pow(2,16);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=32768;data.val=compressed.charCodeAt(data.index++)}bits|=(resb>0?1:0)*power;power<<=1}dictionary[next++]=String.fromCharCode(bits);enlargeIn--;break;case 2:return result.join("")}if(enlargeIn==0){enlargeIn=Math.pow(2,numBits);numBits++}if(dictionary[bits]){c=dictionary[bits]}else{if(bits==next)c=w+w.charAt(0);else return null}result.push(c);dictionary[next++]=w+c.charAt(0);enlargeIn--;w=c;if(enlargeIn==0){enlargeIn=Math.pow(2,numBits);numBits++}}},
            
            compressToEncodedURIComponent:function(uncompressed){if(uncompressed==null)return"";return this.compress(uncompressed).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,".")},
            
            decompressFromEncodedURIComponent:function(compressed){if(compressed==null)return"";if(compressed=="")return null;compressed=compressed.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=");return this.decompress(compressed)}
        };

        const App = {
            pc: null,
            dc: null,
            isInitiator: false,
            shortCode: null,
            currentOffer: null,
            currentAnswer: null,
            reconnectAttempts: 0,
            maxReconnectAttempts: 5,
            iceCandidateBuffer: [],
            connectionStartTime: null,
            
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun.miwifi.com' }
                ],
                iceTransportPolicy: 'all',
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require',
                // å…³é”®ï¼šå¯ç”¨ICEé‡å¯æ”¯æŒ
                iceCandidatePoolSize: 10
            },

            generateShortCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            },

            createRoom() {
                this.isInitiator = true;
                this.shortCode = this.generateShortCode();
                this.saveState();
                this.initConnection();
                
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('chat').classList.remove('hidden');
                document.getElementById('signalPanel').classList.remove('hidden');
                document.getElementById('shortCode').textContent = this.shortCode;
                
                this.addMessage('ç³»ç»Ÿ', `æˆ¿é—´ ${this.shortCode} å·²åˆ›å»ºï¼Œé‚€è¯·ç é•¿æœŸæœ‰æ•ˆï¼Œæ”¯æŒé‡å¤åˆ·æ–°`, 'system');
            },

            joinRoom() {
                this.isInitiator = false;
                document.getElementById('joinSection').classList.remove('hidden');
                document.getElementById('createBtn').classList.add('hidden');
                document.querySelector('#setup button.secondary').classList.add('hidden');
            },

            async initConnection() {
                try {
                    this.pc = new RTCPeerConnection(this.config);
                    this.iceCandidateBuffer = [];
                    
                    if (this.isInitiator) {
                        this.dc = this.pc.createDataChannel('chat', {
                            ordered: true,
                            maxRetransmits: 3
                        });
                        this.setupDataChannel(this.dc);
                    } else {
                        this.pc.ondatachannel = (e) => {
                            this.dc = e.channel;
                            this.setupDataChannel(this.dc);
                        };
                    }

                    // ICE å€™é€‰æ”¶é›†ï¼šç¼“å†²æ‰€æœ‰å€™é€‰ï¼Œç›´åˆ°æ”¶é›†å®Œæˆ
                    this.pc.onicecandidate = (e) => {
                        if (e.candidate) {
                            this.iceCandidateBuffer.push(e.candidate);
                            this.updateTimeDisplay();
                        } else {
                            // ICEæ”¶é›†å®Œæˆï¼Œæ›´æ–°é‚€è¯·ç 
                            this.updateInviteCode();
                        }
                    };

                    this.pc.oniceconnectionstatechange = () => {
                        this.handleConnectionStateChange();
                    };

                    this.pc.onconnectionstatechange = () => {
                        if (this.pc.connectionState === 'connected') {
                            this.connectionStartTime = Date.now();
                            this.saveState();
                        } else if (this.pc.connectionState === 'failed') {
                            this.handleConnectionFailure();
                        }
                    };

                    if (this.isInitiator) {
                        const offer = await this.pc.createOffer();
                        await this.pc.setLocalDescription(offer);
                        // ç­‰å¾…ICEæ”¶é›†å®Œæˆè‡ªåŠ¨è§¦å‘updateInviteCode
                    }
                } catch (e) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', e);
                    this.addMessage('ç³»ç»Ÿ', 'åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
                }
            },

            updateInviteCode() {
                if (!this.isInitiator || !this.pc.localDescription) return;
                
                const sdpData = {
                    type: this.pc.localDescription.type,
                    sdp: this.pc.localDescription.sdp,
                    candidates: this.iceCandidateBuffer,
                    ts: Date.now(),
                    v: 2 // ç‰ˆæœ¬å·
                };
                
                const jsonStr = JSON.stringify(sdpData);
                this.currentOffer = LZString.compressToEncodedURIComponent(jsonStr);
                
                // æ›´æ–°UI
                document.getElementById('updateTime').textContent = 'å·²æ›´æ–° ' + new Date().toLocaleTimeString();
                this.saveState();
            },

            updateTimeDisplay() {
                if (this.isInitiator) {
                    document.getElementById('updateTime').textContent = 'æ”¶é›†å€™é€‰ä¸­... ' + this.iceCandidateBuffer.length + 'ä¸ª';
                }
            },

            // åˆ·æ–°é‚€è¯·ç ï¼ˆICE Restartï¼‰
            async refreshOffer() {
                if (!this.isInitiator || !this.pc) return;
                
                this.addMessage('ç³»ç»Ÿ', 'æ­£åœ¨åˆ·æ–°é‚€è¯·ç ï¼ˆICE Restartï¼‰...', 'system');
                this.iceCandidateBuffer = [];
                
                try {
                    const offer = await this.pc.createOffer({iceRestart: true});
                    await this.pc.setLocalDescription(offer);
                    // ç­‰å¾…æ–°çš„ICEæ”¶é›†å®Œæˆ
                } catch (e) {
                    this.addMessage('ç³»ç»Ÿ', 'åˆ·æ–°å¤±è´¥: ' + e.message, 'error');
                }
            },

            async connect() {
                const input = document.getElementById('joinCode').value.trim();
                if (!input) return alert('è¯·è¾“å…¥æˆ¿é—´ç ');
                
                try {
                    await this.initConnection();
                    
                    let remoteData;
                    
                    if (input.length === 6) {
                        alert('çŸ­ç éœ€è¦é…åˆå®Œæ•´SDPä½¿ç”¨ã€‚è¯·å‘é‚€è¯·æ–¹ç´¢å–å®Œæ•´é‚€è¯·ç ã€‚');
                        return;
                    } else {
                        // è§£å‹
                        try {
                            const decompressed = LZString.decompressFromEncodedURIComponent(input);
                            remoteData = JSON.parse(decompressed);
                        } catch(e) {
                            // å°è¯•æ—§æ ¼å¼
                            remoteData = JSON.parse(atob(input));
                        }
                    }
                    
                    if (remoteData.type === 'offer') {
                        await this.handleOffer(remoteData);
                    }
                } catch (e) {
                    console.error(e);
                    alert('æ— æ•ˆçš„é‚€è¯·ç æˆ–è§£æå¤±è´¥');
                }
            },

            async handleOffer(offerData) {
                try {
                    // å¤„ç†åŒ…å«å€™é€‰çš„Offer
                    await this.pc.setRemoteDescription(new RTCSessionDescription({
                        type: offerData.type,
                        sdp: offerData.sdp
                    }));
                    
                    // æ·»åŠ è¿œç¨‹å€™é€‰
                    if (offerData.candidates) {
                        offerData.candidates.forEach(cand => {
                            this.pc.addIceCandidate(new RTCIceCandidate(cand)).catch(e => console.log('æ·»åŠ å€™é€‰å¤±è´¥:', e));
                        });
                    }
                    
                    const answer = await this.pc.createAnswer();
                    await this.pc.setLocalDescription(answer);
                    
                    // ç­‰å¾…ICEæ”¶é›†å®Œæˆæ˜¾ç¤ºç­”æ¡ˆ
                    setTimeout(() => {
                        const answerData = {
                            type: this.pc.localDescription.type,
                            sdp: this.pc.localDescription.sdp,
                            candidates: this.iceCandidateBuffer,
                            ts: Date.now()
                        };
                        const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(answerData));
                        this.currentAnswer = compressed;
                        
                        document.getElementById('setup').classList.add('hidden');
                        document.getElementById('chat').classList.remove('hidden');
                        document.getElementById('joinerPanel').classList.remove('hidden');
                        document.getElementById('answerCode').value = compressed;
                        
                        this.addMessage('ç³»ç»Ÿ', 'è¯·å¤åˆ¶ä¸Šæ–¹å“åº”ç å‘ç»™é‚€è¯·æ–¹', 'system');
                    }, 1000);
                    
                } catch (e) {
                    this.addMessage('ç³»ç»Ÿ', 'å¤„ç†é‚€è¯·ç å¤±è´¥: ' + e.message, 'error');
                }
            },

            async completeConnection() {
                const response = document.getElementById('responseCode').value.trim();
                if (!response) return;
                
                try {
                    let data;
                    try {
                        const decompressed = LZString.decompressFromEncodedURIComponent(response);
                        data = JSON.parse(decompressed);
                    } catch(e) {
                        data = JSON.parse(atob(response));
                    }
                    
                    await this.pc.setRemoteDescription(new RTCSessionDescription({
                        type: data.type,
                        sdp: data.sdp
                    }));
                    
                    if (data.candidates) {
                        data.candidates.forEach(cand => {
                            this.pc.addIceCandidate(new RTCIceCandidate(cand)).catch(e => {});
                        });
                    }
                    
                    document.getElementById('responseCode').value = '';
                    
                } catch(e) {
                    alert('æ— æ•ˆçš„å“åº”ç : ' + e.message);
                }
            },

            handleConnectionStateChange() {
                const state = this.pc.iceConnectionState;
                document.getElementById('connStatus').textContent = state;
                
                const badge = document.getElementById('connType');
                
                if (state === 'connected' || state === 'completed') {
                    badge.textContent = this.isInitiator ? 'å·²è¿æ¥(ä¸»æœº)' : 'å·²è¿æ¥(è®¿å®¢)';
                    badge.className = 'badge direct';
                    document.getElementById('signalPanel').classList.add('hidden');
                    document.getElementById('joinerPanel').classList.add('hidden');
                    document.getElementById('input').style.display = 'flex';
                    this.addMessage('ç³»ç»Ÿ', 'âœ… è¿æ¥æˆåŠŸï¼', 'system');
                    this.reconnectAttempts = 0;
                    this.saveState();
                } else if (state === 'checking') {
                    badge.textContent = 'è¿æ¥ä¸­...';
                    badge.className = 'badge waiting';
                } else if (state === 'failed') {
                    badge.textContent = 'è¿æ¥å¤±è´¥';
                    badge.className = 'badge failed';
                    this.addMessage('ç³»ç»Ÿ', 'âŒ è¿æ¥å¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é‚€è¯·ç æˆ–é‡æ–°è¿æ¥', 'error');
                } else if (state === 'disconnected') {
                    badge.textContent = 'å·²æ–­å¼€';
                    badge.className = 'badge failed';
                    this.handleDisconnection();
                }
            },

            handleDisconnection() {
                this.addMessage('ç³»ç»Ÿ', 'è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿...', 'system');
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    setTimeout(() => {
                        if (this.pc && this.isInitiator) {
                            this.refreshOffer();
                        }
                    }, 2000);
                } else {
                    this.addMessage('ç³»ç»Ÿ', 'é‡è¿æ¬¡æ•°è¶…é™ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°', 'error');
                }
            },

            handleConnectionFailure() {
                this.addMessage('ç³»ç»Ÿ', 'è¿æ¥å»ºç«‹å¤±è´¥ï¼Œå»ºè®®ä½¿ç”¨"åˆ·æ–°é‚€è¯·ç "é‡æ–°ç”Ÿæˆ', 'error');
            },

            setupDataChannel(dc) {
                dc.onopen = () => {
                    console.log('DataChannel å·²è¿æ¥');
                };
                
                dc.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        this.addMessage('å¯¹æ–¹', data.msg, 'other');
                    } catch(err) {
                        this.addMessage('å¯¹æ–¹', e.data, 'other');
                    }
                };

                dc.onclose = () => {
                    this.addMessage('ç³»ç»Ÿ', 'æ•°æ®é€šé“å·²å…³é—­', 'system');
                };
            },

            send() {
                const input = document.getElementById('msgInput');
                const msg = input.value.trim();
                if (!msg || !this.dc || this.dc.readyState !== 'open') {
                    if (this.dc?.readyState !== 'open') {
                        this.addMessage('ç³»ç»Ÿ', 'å°šæœªè¿æ¥ï¼Œæ— æ³•å‘é€', 'error');
                    }
                    return;
                }
                
                this.dc.send(JSON.stringify({msg, time: Date.now()}));
                this.addMessage('æˆ‘', msg, 'self');
                input.value = '';
            },

            addMessage(from, text, type) {
                const div = document.createElement('div');
                div.className = `msg ${type}`;
                const time = new Date().toLocaleTimeString();
                div.innerHTML = `<div style="font-size:11px;opacity:0.7;margin-bottom:4px">${from} Â· ${time}</div><div>${text}</div>`;
                document.getElementById('messages').appendChild(div);
                div.scrollIntoView({behavior: 'smooth'});
            },

            copyInvite() {
                if (!this.currentOffer) return;
                navigator.clipboard.writeText(this.currentOffer);
                this.addMessage('ç³»ç»Ÿ', 'é‚€è¯·ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆé•¿åº¦ï¼š' + this.currentOffer.length + 'ï¼‰', 'system');
            },

            copyAnswer() {
                if (!this.currentAnswer) return;
                navigator.clipboard.writeText(this.currentAnswer);
                this.addMessage('ç³»ç»Ÿ', 'å“åº”ç å·²å¤åˆ¶', 'system');
            },

            disconnect() {
                if (confirm('ç¡®å®šè¦æ–­å¼€è¿æ¥å—ï¼Ÿ')) {
                    this.cleanup();
                    location.reload();
                }
            },

            cleanup() {
                if (this.dc) this.dc.close();
                if (this.pc) this.pc.close();
                this.dc = null;
                this.pc = null;
                localStorage.removeItem('p2p_state');
            },

            saveState() {
                const state = {
                    isInitiator: this.isInitiator,
                    shortCode: this.shortCode,
                    offer: this.currentOffer,
                    timestamp: Date.now(),
                    connected: this.pc?.connectionState === 'connected'
                };
                localStorage.setItem('p2p_state', JSON.stringify(state));
            },

            restoreState() {
                try {
                    const saved = localStorage.getItem('p2p_state');
                    if (!saved) return false;
                    
                    const state = JSON.parse(saved);
                    const age = Date.now() - state.timestamp;
                    
                    // å¦‚æœçŠ¶æ€æ˜¯å·²è¿æ¥ä¸”ä¸è¶…è¿‡24å°æ—¶ï¼Œå°è¯•æ¢å¤
                    if (state.connected && age < 24 * 3600 * 1000) {
                        if (confirm(`æ£€æµ‹åˆ°ä¹‹å‰çš„ä¼šè¯ï¼ˆ${state.shortCode}ï¼‰ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ`)) {
                            // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„æ¢å¤é€»è¾‘
                            return true;
                        }
                    } else if (!state.connected && age < 3600 * 1000) {
                        // æœªè¿æ¥çŠ¶æ€ä¸”ä¸è¶…è¿‡1å°æ—¶
                        if (confirm(`æ£€æµ‹åˆ°æœªå®Œæˆçš„æˆ¿é—´ ${state.shortCode}ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                            this.isInitiator = state.isInitiator;
                            this.shortCode = state.shortCode;
                            if (this.isInitiator) {
                                this.createRoom();
                            }
                            return true;
                        }
                    }
                    localStorage.removeItem('p2p_state');
                    return false;
                } catch(e) {
                    return false;
                }
            }
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            App.restoreState();
        });

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', () => {
            App.saveState();
        });
    </script>
</body>
</html>
