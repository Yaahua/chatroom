<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero-TURN P2P (P2PTç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/p2pt@1.5.0/dist/p2pt.min.js"></script>
    <style>
        :root{--bg:#0f0f0f;--bg2:#1a1a1a;--text:#e0e0e0;--accent:#00d084;--err:#ff4757;--warn:#ffa502}
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
        body{background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
        .hidden{display:none!important}
        
        #setup{height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
        .card{background:var(--bg2);padding:30px;border-radius:16px;max-width:500px;width:100%;border:1px solid #333}
        h1{font-size:24px;margin-bottom:10px;color:var(--accent)}
        .info{font-size:12px;color:#888;margin-bottom:20px;line-height:1.5}
        
        button{width:100%;padding:14px;margin:8px 0;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:bold;cursor:pointer;font-size:14px}
        button:hover{opacity:0.9}
        button:disabled{opacity:0.5;cursor:not-allowed}
        
        .code-display{font-size:32px;font-weight:bold;color:var(--accent);letter-spacing:8px;text-align:center;padding:20px;background:rgba(0,208,132,0.1);border-radius:8px;margin:20px 0;border:2px dashed var(--accent);font-family:monospace}
        
        #chat{height:100%;display:flex;flex-direction:column;padding:20px}
        #status{padding:10px;background:var(--bg2);border-radius:8px;margin-bottom:10px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
        .badge{padding:4px 8px;border-radius:4px;font-size:11px;background:#333}
        .badge.direct{background:var(--accent);color:#000}
        
        #messages{flex:1;overflow-y:auto;padding:10px;background:#000;border-radius:8px;margin-bottom:10px;border:1px solid #333}
        .msg{margin:8px 0;padding:10px;background:var(--bg2);border-radius:8px;max-width:80%;word-break:break-all}
        .msg.self{margin-left:auto;background:rgba(0,208,132,0.2);border:1px solid var(--accent)}
        .msg.system{text-align:center;background:transparent;color:#666;font-size:12px;max-width:100%}
        
        #input{display:flex;gap:10px}
        #input input{flex:1;padding:12px;background:var(--bg2);border:1px solid #444;border-radius:8px;color:var(--text)}
        #input button{width:auto;padding:12px 24px;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:bold;cursor:pointer}
        
        .loading{display:flex;align-items:center;justify-content:center;gap:10px;color:var(--warn);margin:20px 0}
        .spinner{width:20px;height:20px;border:2px solid var(--warn);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        input[type="text"]{width:100%;padding:12px;background:#000;border:1px solid #444;border-radius:8px;color:var(--text);text-transform:uppercase;font-family:monospace;font-size:16px;text-align:center;letter-spacing:4px;margin:10px 0}
    </style>
</head>
<body>
    <div id="setup">
        <div class="card">
            <h1>ğŸ”® Zero-TURN P2P (P2PTç‰ˆ)</h1>
            <div class="info">
                <strong>åŸºäºå…¬å…±BTç½‘ç»œçš„ä¿¡ä»¤</strong><br>
                â€¢ æ— éœ€æ³¨å†Œï¼Œæ— éœ€API Key<br>
                â€¢ ä½¿ç”¨WebTorrentå…¬å…±Tracker<br>
                â€¢ è‡ªåŠ¨ç©¿é€NATï¼Œæ”¯æŒè·¨ç½‘æ®µ<br>
                <span style="color:var(--warn)">æç¤ºï¼šé¦–æ¬¡è¿æ¥å¯èƒ½éœ€è¦10-20ç§’å¯»æ‰¾èŠ‚ç‚¹</span>
            </div>
            
            <button onclick="App.createRoom()" id="createBtn">åˆ›å»ºæˆ¿é—´</button>
            <button onclick="App.showJoin()" id="joinBtn" style="background:#333;color:var(--text)">åŠ å…¥æˆ¿é—´</button>
            
            <div id="createPanel" class="hidden">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>æ­£åœ¨è¿æ¥å…¨çƒTracker...</span>
                </div>
                <div class="code-display" id="roomCodeDisplay" style="display:none"></div>
                <div style="font-size:11px;color:#666;text-align:center;margin-top:10px" id="createHint"></div>
            </div>
            
            <div id="joinPanel" class="hidden" style="margin-top:20px">
                <label style="font-size:12px;color:#888">è¾“å…¥6ä½æˆ¿é—´ç ï¼š</label>
                <input type="text" id="joinCode" placeholder="ABC123" maxlength="6">
                <button onclick="App.joinRoom()" id="connectBtn">è¿æ¥</button>
            </div>
        </div>
    </div>

    <div id="chat" class="hidden">
        <div id="status">
            <span>
                æˆ¿é—´: <span id="roomId" style="color:var(--accent);font-weight:bold">-</span>
                <span id="connBadge" class="badge" style="margin-left:10px">è¿æ¥ä¸­...</span>
            </span>
            <button onclick="location.reload()" style="background:#333;color:var(--text);padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:12px">é€€å‡º</button>
        </div>
        
        <div id="messages"></div>
        
        <div id="input">
            <input type="text" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="1000" onkeypress="if(event.key==='Enter')App.send()">
            <button onclick="App.send()">å‘é€</button>
        </div>
    </div>

    <script>
        const App = {
            p2pt: null,
            peers: [],
            roomCode: null,
            isInitiator: false,
            
            // å…¬å…±WebTorrent Trackeråˆ—è¡¨ï¼ˆé•¿æœŸæœ‰æ•ˆï¼‰
            trackers: [
                'wss://tracker.openwebtorrent.com',
                'wss://tracker.files.fm:7073/announce',
                'wss://spacetradersapi-chatbox.fly.dev:443/announce',
                'wss://tracker.webtorrent.dev'
            ],

            generateCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            },

            createRoom() {
                this.isInitiator = true;
                this.roomCode = this.generateCode();
                
                document.getElementById('createBtn').classList.add('hidden');
                document.getElementById('joinBtn').classList.add('hidden');
                document.getElementById('createPanel').classList.remove('hidden');
                
                this.initP2PT();
            },

            showJoin() {
                document.getElementById('joinPanel').classList.remove('hidden');
                document.getElementById('joinBtn').classList.add('hidden');
                document.getElementById('createBtn').classList.add('hidden');
                document.getElementById('joinCode').focus();
            },

            joinRoom() {
                const code = document.getElementById('joinCode').value.trim().toUpperCase();
                if (code.length !== 6) return alert('è¯·è¾“å…¥6ä½æˆ¿é—´ç ');
                
                this.isInitiator = false;
                this.roomCode = code;
                
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = 'è¿æ¥ä¸­...';
                
                this.initP2PT();
            },

            initP2PT() {
                // ä½¿ç”¨æˆ¿é—´ç ä½œä¸ºç§å­æ ‡è¯†
                const identifier = 'p2p-chat-' + this.roomCode;
                
                try {
                    this.p2pt = new P2PT(this.trackers, identifier);
                    
                    this.p2pt.on('trackerconnect', (tracker, stats) => {
                        console.log('Connected to tracker:', tracker, 'peers:', stats.connected);
                        if (this.isInitiator) {
                            document.getElementById('createHint').textContent = 'ç­‰å¾…å¯¹æ–¹åŠ å…¥... (å·²è¿æ¥ ' + stats.connected + ' ä¸ªèŠ‚ç‚¹)';
                        }
                    });
                    
                    this.p2pt.on('peerconnect', (peer) => {
                        console.log('New peer connected:', peer);
                        this.peers.push(peer);
                        this.onConnect();
                    });
                    
                    this.p2pt.on('peerclose', (peer) => {
                        console.log('Peer disconnected:', peer);
                        this.peers = this.peers.filter(p => p !== peer);
                        this.addMessage('ç³»ç»Ÿ', 'å¯¹æ–¹å·²æ–­å¼€', 'system');
                    });
                    
                    this.p2pt.on('msg', (peer, msg) => {
                        console.log('Received:', msg);
                        if (msg.type === 'chat') {
                            this.addMessage('å¯¹æ–¹', msg.data, 'other');
                        } else if (msg.type === 'join' && this.isInitiator) {
                            // æœ‰äººåŠ å…¥ï¼Œå‘é€ç¡®è®¤
                            this.p2pt.send(peer, JSON.stringify({type: 'welcome'}));
                        }
                    });
                    
                    // å¯åŠ¨è¿æ¥
                    this.p2pt.start();
                    
                    if (this.isInitiator) {
                        setTimeout(() => {
                            document.querySelector('.loading').style.display = 'none';
                            document.getElementById('roomCodeDisplay').style.display = 'block';
                            document.getElementById('roomCodeDisplay').textContent = this.roomCode;
                            document.getElementById('createHint').textContent = 'å°†æˆ¿é—´ç å‘ç»™å¯¹æ–¹ï¼Œç­‰å¾…è¿æ¥...';
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            if (this.peers.length === 0) {
                                alert('æœªæ‰¾åˆ°æˆ¿é—´ï¼Œè¯·æ£€æŸ¥æˆ¿é—´ç æˆ–è®©å¯¹æ–¹é‡æ–°åˆ›å»º');
                                location.reload();
                            }
                        }, 15000);
                    }
                    
                } catch (e) {
                    console.error('P2PTåˆå§‹åŒ–å¤±è´¥:', e);
                    alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
                }
            },

            onConnect() {
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('chat').classList.remove('hidden');
                document.getElementById('roomId').textContent = this.roomCode;
                document.getElementById('connBadge').textContent = 'å·²è¿æ¥';
                document.getElementById('connBadge').className = 'badge direct';
                
                this.addMessage('ç³»ç»Ÿ', 'âœ… è¿æ¥æˆåŠŸï¼å¯ä»¥å¼€å§‹èŠå¤©äº†', 'system');
                
                if (!this.isInitiator) {
                    // åŠ å…¥è€…å‘é€åŠ å…¥æ¶ˆæ¯
                    setTimeout(() => {
                        if (this.peers.length > 0) {
                            this.p2pt.send(this.peers[0], JSON.stringify({type: 'join'}));
                        }
                    }, 500);
                }
            },

            send() {
                const input = document.getElementById('msgInput');
                const msg = input.value.trim();
                if (!msg || this.peers.length === 0) {
                    alert('æœªè¿æ¥æˆ–æ¶ˆæ¯ä¸ºç©º');
                    return;
                }
                
                // å‘é€ç»™æ‰€æœ‰å¯¹ç­‰èŠ‚ç‚¹
                this.peers.forEach(peer => {
                    this.p2pt.send(peer, JSON.stringify({
                        type: 'chat',
                        data: msg,
                        time: Date.now()
                    }));
                });
                
                this.addMessage('æˆ‘', msg, 'self');
                input.value = '';
            },

            addMessage(from, text, type) {
                const div = document.createElement('div');
                div.className = `msg ${type}`;
                const time = new Date().toLocaleTimeString();
                div.innerHTML = `<div style="font-size:11px;opacity:0.7;margin-bottom:4px">${from} Â· ${time}</div><div>${text}</div>`;
                document.getElementById('messages').appendChild(div);
                div.scrollIntoView({behavior: 'smooth'});
            }
        };
    </script>
</body>
</html>
